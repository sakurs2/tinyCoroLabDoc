---
show: step
version: 1.0
enable_checker: true
---
# tinyCoroLab5a: æ„å»ºè¿›é˜¶åç¨‹åŒæ­¥ç»„ä»¶when_allï¼ˆé€‰åšï¼‰

## tinyCoroLab5aå®éªŒç®€ä»‹

æœ¬èŠ‚æˆ‘ä»¬å°†æ­£å¼å¼€å§‹tinyCoroLab5aï¼Œæ³¨æ„ï¼ä¸å†æ˜¯æ„å»ºåŸºç¡€åç¨‹åŒæ­¥ç»„ä»¶ï¼Œè€Œæ˜¯è¿›é˜¶åç¨‹åŒæ­¥ç»„ä»¶ï¼ï¼ï¼æ—¢ç„¶æ˜¯è¿›é˜¶ï¼Œé‚£ä¹ˆå®ç°ä¸Šå¯èƒ½ä¼šæœ‰ä¸€ä¸¢ä¸¢å°å¤æ‚ï¼Œè€Œæœ¬èŠ‚å°†è¦å®ç°çš„æ˜¯ä¸€ä¸ªåç¨‹å‡½æ•°when_allï¼Œæ³¨æ„æœ¬èŠ‚å®éªŒå±äºé€‰åšï¼Œå› ä¸ºtinyCoroåœ¨when_allçš„è®¾è®¡ä¸Šå­˜åœ¨ç¼ºé™·ï¼Œæ‰€ä»¥èƒ½ç”¨ä½†æ¯”è¾ƒé¸¡è‚‹ï¼Œåç»­ä¼šé‡æ„æ­¤éƒ¨åˆ†ï¼Œä½†ä»å­¦ä¹ çŸ¥è¯†çš„è§’åº¦è®²æœ¬èŠ‚å®éªŒè¿˜æ˜¯æ¨èå®éªŒè€…å®Œæˆçš„ã€‚

#### é¢„å¤‡çŸ¥è¯†

> âš ï¸é¢„å¤‡çŸ¥è¯†å³åœ¨å®éªŒå¼€å§‹å‰ä½ åº”è¯¥å·²ç»æŒæ¡çš„çŸ¥è¯†ï¼Œä¸”åœ¨[çŸ¥è¯†é“ºå«ç« èŠ‚]()ä¸­å‡æœ‰æ¶‰åŠ

- **C++åç¨‹awaiterçš„æ¦‚å¿µ**
- **C++æ¨¡æ¿ç¼–ç¨‹**
- **C++ concepts**

## ğŸ“–lab5aä»»åŠ¡ä¹¦

### å®éªŒå‰ç½®è®²è§£

æœ¬èŠ‚å®éªŒæ¶‰åŠåˆ°çš„æ ¸å¿ƒæ–‡ä»¶ä¸º[include/coro/comp/when_all.hpp](https://github.com/sakurs2/tinyCoroLab/blob/master/include/coro/comp/when_all.hpp)ï¼Œå®éªŒè€…éœ€è¦é¢„å…ˆæ‰“å¼€æ–‡ä»¶æµè§ˆå¤§è‡´ä»£ç ç»“æ„ï¼Œä¸‹é¢é’ˆå¯¹è¯¥æ–‡ä»¶å†…å®¹è¿›è¡Œè®²è§£ã€‚

è¯¥æ–‡ä»¶é¢„å…ˆå®šä¹‰äº†ä¸€ä¸ªwhen_allå‡½æ•°å¯ä»¥æ¥æ”¶å¤šä¸ªå‚æ•°ï¼Œå¹¶ç”¨conceptsçº¦æŸå‚æ•°åˆ—è¡¨ä¸­çš„æ¯ä¸ªå‚æ•°å¿…é¡»æ˜¯awaitableç±»å‹ï¼Œå› æ­¤when_allçš„ä½œç”¨ä¾¿æ˜¯ç­‰å¾…å‚æ•°åˆ—è¡¨ä¸­çš„æ‰€æœ‰awaitableæ‰§è¡Œå®Œæ¯•å†è¿”å›ã€‚

è¯¥æ–‡ä»¶å†…å®šä¹‰çš„awaiteråªæ˜¯ä¸ºäº†è®©é¡¹ç›®ç¼–è¯‘é€šè¿‡ï¼Œä¸å…·æœ‰å®é™…æ„ä¹‰ï¼Œå®éªŒè€…éœ€è¦å®ç°è‡ªå·±éœ€è¦çš„awaiterã€‚

### âš ï¸æ³¨æ„äº‹é¡¹

- è¯·ç¡®ä¿å·²é˜…è¯»è¿‡**tinyCoroLab Introduce**ç« èŠ‚ã€‚
- ä¸ºäº†ç¡®ä¿æ­£ç¡®å®ç°ç›®æ ‡å‡½æ•°ï¼Œå®éªŒè€…å¯èƒ½éœ€è¦åšä¸€äº›é¢å¤–æ“ä½œï¼šæ–°å¢ç±»ã€ä¿®æ”¹ç°æœ‰ç±»çš„å®ç°ã€è¡¥å……ç°æœ‰ç±»çš„æ–¹æ³•å’Œæˆå‘˜å˜é‡ç­‰æ“ä½œï¼Œè¯·éµå¾ª**free-designå®éªŒåŸåˆ™**ã€‚
- ä½ éœ€è¦ä»”ç»†è¯„ä¼°å¾…å®ç°çš„æ¥å£æ˜¯å¦éœ€è¦æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚
- ä»»ä½•å¯¼è‡´æµ‹è¯•å¡ä½ã€å´©æºƒç­‰æ— æ³•ä½¿æµ‹è¯•é¡ºåˆ©é€šè¿‡çš„æƒ…å†µéƒ½è¡¨æ˜ä½ çš„ä»£ç å­˜åœ¨é—®é¢˜ã€‚

### å®éªŒä»»åŠ¡ä¹¦

#### ğŸ§‘â€ğŸ’»Task #1 - å®ç°when_all

##### ä»»åŠ¡ç›®æ ‡

when_allçš„å‚æ•°å®éªŒè€…å¯ä»¥ç†è§£ä¸ºæ˜¯ä¸€ä¸ªä¸ªå¾…å®Œæˆçš„åç¨‹ä»»åŠ¡ï¼Œå…¶å…·ä½“è¡Œä¸ºå—åˆ°å‚æ•°åˆ—è¡¨çš„å½±å“ã€‚

å½“å‚æ•°åˆ—è¡¨çš„awaitableç±»å‹çš„await_resumeå…¨éƒ¨è¿”å›voidæ—¶ï¼Œé‚£ä¹ˆ**when_allçš„ä½œç”¨æ˜¯è¿è¡Œæ‰€æœ‰awaitableå¹¶ç­‰å¾…æ‰€æœ‰awaitableè¿”å›ï¼Œå…¶è¿”å›çš„awaiterçš„await_resumeå‡½æ•°è¿”å›ç±»å‹ä¸ºvoidã€‚**

å½“å‚æ•°åˆ—è¡¨çš„awaitableç±»å‹çš„await_resumeå…¨éƒ¨évoidä¸”ç±»å‹ä¸€è‡´æ—¶ï¼Œé‚£ä¹ˆ**when_allçš„ä½œç”¨åŒæ ·æ˜¯è¿è¡Œæ‰€æœ‰awaitableå¹¶ç­‰å¾…æ‰€æœ‰awaitableè¿”å›ï¼Œä½†å…¶è¿”å›çš„awaiterçš„await_resumeå‡½æ•°è¿”å›ç±»å‹ä¸å†æ˜¯voidï¼Œè€Œæ˜¯ä¸€ä¸ªæ”¯æŒC++ Range-based for loopè¯­æ³•çš„å®¹å™¨ï¼Œå³when_allä¼šæ”¶é›†å‚æ•°awaitableçš„è¿”å›å€¼å¹¶ä»¥å®¹å™¨å½¢å¼è¿”å›ï¼Œä½†å­˜å‚¨é¡ºåºä¸åšè¦æ±‚ã€‚**

**å®éªŒè€…è‚¯å®šä¼šé—®å¦‚æœå‚æ•°åˆ—è¡¨çš„awaitableç±»å‹çš„await_resumeè¿”å›ç±»å‹ä¸ä¸€è‡´æ€ä¹ˆåŠï¼Ÿ** tinyCoroçš„å®ç°æ˜¯åˆ©ç”¨conceptså¯¹å‚æ•°çº¦æŸï¼Œå¦‚æœå‡ºç°è¿™ç§æƒ…å†µä¼šåœ¨ç¼–è¯‘æœŸæŠ¥é”™ï¼Œå³æé†’ç”¨æˆ·è¿™æ ·çš„åšæ³•ä¸å¯¹ï¼Œå½“ç„¶å®éªŒè€…ä¸å¿…è€ƒè™‘è¿™ç§æƒ…å†µäº†ï¼Œè‡³å°‘æµ‹è¯•ä¸­when_allå‚æ•°åˆ—è¡¨çš„æ‰€æœ‰awaitableå…¶await_resumeè¿”å›ç±»å‹éƒ½æ˜¯ä¸€è‡´çš„ã€‚

**æ€ä¹ˆç†è§£when_alléœ€è¦è¿è¡Œæ‰€æœ‰awaitableå‚æ•°å‘¢ï¼Ÿæ˜¯åœ¨when_allé‡Œä¸€ä¸ªä¸ªæ‰§è¡Œå—ï¼Ÿ** è¿™é‡Œçš„è¿è¡ŒæŒ‡çš„æ˜¯å°†å…¶æ´¾å‘åˆ°è°ƒåº¦å™¨ä¸­ï¼Œç„¶åè°ƒç”¨when_allçš„åç¨‹é™·å…¥suspendçŠ¶æ€ã€‚

> **ğŸ’¡tinyCoroLabé‡Œæœ‰`submit_to_scheduler`å’Œ`submit_to_context`ä¸¤ç§ä»»åŠ¡æ´¾å‘æ–¹å¼ï¼Œå®éªŒè€…é€‰å–å“ªç§éƒ½è¡Œï¼Œä½†åªæœ‰`submit_to_scheduler`æ‰èƒ½åˆ©ç”¨å¤šçº¿ç¨‹**

<!-- > **ğŸ’¡å°†å‚æ•°awaitableæ´¾å‘åˆ°ä¸è°ƒç”¨when_allçš„åç¨‹ç›¸åŒçš„contextä¸­ï¼Œé‚£å²‚ä¸æ˜¯ç­‰åŒäºé¡ºåºæ‰§è¡Œï¼Ÿ**
> æ˜¯çš„ï¼Œä½†tinyCoroæ­£åœ¨ä¿®å¤æ­¤éƒ¨åˆ†è®¾è®¡ç¼ºé™·ï¼Œè€Œä¿®å¤å®Œæˆåä½ å¯ä»¥é€‰æ‹©æ´¾å‘åˆ°åˆ«çš„contextä¸­ï¼Œæ­¤æ—¶åªéœ€è¦ä¿®æ”¹ç”¨äºæ´¾å‘ä»»åŠ¡çš„ä¸€è¡Œä»£ç å³å¯ã€‚ -->

å®éªŒè€…åº”å½“èƒ½å‘ç°when_allæ˜¯latchçš„ä¸€ç§ä½¿ç”¨åœºæ™¯ï¼Œå› æ­¤å®éªŒè€…å¯å€ŸåŠ©latchç®€åŒ–when_allçš„å®ç°ã€‚

ä¸‹é¢ç»™å‡ºwhen_allçš„ä½¿ç”¨åœºæ™¯ä¾¿äºå®éªŒè€…ç†è§£ï¼š

```cpp
// when_allå‚æ•°åˆ—è¡¨awaitableå…¨éƒ¨è¿”å›void
task<> empty_func() {
  // codes...
  co_return;
}
task<> when_all_func() {
  co_await when_all(empty_func(),empty_func(),empty_func());
  // codes...
}

// when_allå‚æ•°åˆ—è¡¨awaitableå…¨éƒ¨è¿”å›int
task<int> return_int_func() {
  // codes...
  co_return number;
}
task<> when_all_func() {
  auto container = co_await when_all(return_int_func(),return_int_func(),return_int_func());
  for(auto&it:container) {
    // codes...
  }
}
```

##### æ¶‰åŠæ–‡ä»¶

- [include/coro/comp/when_all.hpp](https://github.com/sakurs2/tinyCoroLab/blob/master/include/coro/comp/when_all.hpp)

##### å¾…å®ç°å‡½æ•°

- `coro::when_all`

#### è¡¥å……è¯´æ˜

- **ä½ çš„å®ç°å¿…é¡»åŒ…å«ä»»åŠ¡ç›®æ ‡ä¸­æè¿°çš„å‡½æ•°ä¸”å‡½æ•°å£°æ˜å½¢å¼å¿…é¡»ä¸€è‡´ï¼Œä¸ç„¶æ— æ³•æ­£å¸¸ç¼–è¯‘**
- **åç¨‹å‡½æ•°çš„è¿”å›ç±»å‹å¯ä»¥è¢«ä¿®æ”¹ï¼Œä½†å¿…é¡»æ˜¯awaiteræˆ–è€…awaitableç±»å‹ä¸”await_resumeè¿”å›ç±»å‹ä¸ä»»åŠ¡ä¹¦è§„å®šä¸€è‡´**
- **è¯·åŠ¡å¿…è€ƒè™‘å¤šçº¿ç¨‹å®‰å…¨æ€§é—®é¢˜**

### ğŸ”–æµ‹è¯•

#### åŠŸèƒ½æµ‹è¯•

åŠŸèƒ½æµ‹è¯•åœºæ™¯ä¸»è¦é’ˆå¯¹ï¼š

- **when_allå‚æ•°åˆ—è¡¨awaitableå…¨éƒ¨è¿”å›voidä¸‹çš„åŠŸèƒ½æµ‹è¯•**
- **when_allå‚æ•°åˆ—è¡¨awaitableå…¨éƒ¨è¿”å›évoidä¸‹çš„åŠŸèƒ½æµ‹è¯•**

å®Œæˆæœ¬èŠ‚å®éªŒåï¼Œå®éªŒè€…è¯·åœ¨æ„å»ºç›®å½•ä¸‹æ‰§è¡Œä¸‹åˆ—æŒ‡ä»¤æ¥æ„å»ºä»¥åŠè¿è¡Œæµ‹è¯•ç¨‹åºï¼š

```shell
make build-lab5a # æ„å»º
make test-lab5a # è¿è¡Œ
```

#### å†…å­˜å®‰å…¨æµ‹è¯•

åœ¨æ„å»ºç›®å½•ä¸‹è¿è¡Œä¸‹åˆ—æŒ‡ä»¤æ¥æ‰§è¡Œå†…å­˜å®‰å…¨æµ‹è¯•ï¼š

```shell
make memtest-lab5a
```

æµ‹è¯•é€šè¿‡ä¼šæç¤ºpassï¼Œä¸é€šè¿‡ä¼šç»™å‡ºvalgrindçš„è¾“å‡ºæ–‡ä»¶ä½ç½®ï¼Œè¯·å®éªŒè€…æ ¹æ®è¯¥æ–‡ä»¶æ’æŸ¥å†…å­˜æ•…éšœã€‚
