---
show: step
version: 1.0
enable_checker: true
---

# C++åç¨‹å…¥é—¨å®è·µ

## C++åç¨‹å…¥é—¨å®è·µ

ä¸Šä¸€èŠ‚æˆ‘ä»¬ä»é¡¶å±‚è®¾è®¡çš„è§’åº¦å­¦ä¹ äº†C++çš„è®¾è®¡ç†å¿µï¼Œè€Œæœ¬èŠ‚åˆ™ä»å®è·µçš„è§’åº¦è¿›è¡ŒC++åç¨‹çš„å…¥é—¨ã€‚ä¸ç½‘ä¸Šå¤§éƒ¨åˆ†çš„C++åç¨‹å…¥é—¨åšå®¢ç±»ä¼¼ï¼Œæœ¬æ–‡ä¹Ÿä¼šè®²è¿°C++20ä¸ºåç¨‹è®¾è®¡çš„å…³é”®å­—ä»¥åŠæ–¹æ³•å¹¶ç»™å‡ºç¤ºä¾‹ï¼Œä½†æœ¬æ–‡ä¼šå°½åŠ›ç…§é¡¾åˆå­¦è€…ç»™å‡ºååˆ†è¯¦ç»†çš„è®²è§£ï¼Œç”±äºçŸ¥è¯†ç‚¹è¿‡äºåºå¤§ï¼Œå¦‚æœ‰é”™è¯¯åŠæ—¶åœ¨QQç¾¤å†…åé¦ˆã€‚

#### çŸ¥è¯†ç‚¹

- C++åç¨‹ä¹‹promiseç¼–ç¨‹
- C++åç¨‹ä¹‹awaiterç¼–ç¨‹
- C++åç¨‹ä¹‹å®æˆ˜æ¼”ç»ƒ

## C++åç¨‹çš„å®šä¹‰å’Œæ‰§è¡Œ

å¦‚æœæˆ‘ä»¬åœ¨C++çš„å‡½æ•°ä½“é‡Œæ·»åŠ äº†co_awaitï¼Œco_returnæˆ–è€…co_yieldå…³é”®å­—ï¼ˆå¿…é¡»æœ‰å…¶ä¸€ï¼‰ï¼Œé‚£ä¹ˆè¯¥å‡½æ•°å³è§†ä¸ºåç¨‹ã€‚è€Œè¢«è§†ä½œåç¨‹çš„å‡½æ•°ä¹Ÿä¼šå—åˆ°è¯¸å¤šé™åˆ¶ï¼Œä¾‹å¦‚ä¸å¯ä»¥ä½¿ç”¨returnè¯­å¥ï¼Œæ„é€ å‡½æ•°ã€ææ„å‡½æ•°ã€mainå‡½æ•°å’Œconstexprå‡½æ•°å‡ä¸èƒ½æˆä¸ºåç¨‹ã€‚

æ¯ä¸€ä¸ªåç¨‹å‡½æ•°éƒ½å¯¹åº”ç€ä¸€ä¸ªåç¨‹å¯¹è±¡ï¼Œè€Œåç¨‹å¯¹è±¡ä¸ä¸‹è¿°ä¸‰ç§ç±»å‹çš„æ•°æ®ç›¸å…³è”ã€‚

- **promiseå¯¹è±¡**ã€‚æ³¨æ„è¿™é‡Œçš„promiseä»…ä»…æ˜¯ä¸ªæ¦‚å¿µåè¯ï¼Œå’ŒC++å¼‚æ­¥ç¼–ç¨‹é‡Œçš„std::promiseæ²¡æœ‰ä»»ä½•å…³è”ã€‚åç¨‹çš„æ„é€ å’Œè¿è¡Œéœ€è¦ç¼–è¯‘å™¨åšå¾ˆå¤šå¹•åå·¥ä½œï¼Œè€Œpromiseæ˜¯ç¼–è¯‘å™¨ç›´æ¥æš´éœ²ç»™ç”¨æˆ·çš„ä¸€ä¸ªå¯¹è±¡ï¼Œå…¶ä¸åç¨‹çš„è¿è¡ŒçŠ¶æ€ç›¸å…³è”ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡promiseçš„é¢„å®šä¹‰æ–¹æ³•å®ç°è°ƒåº¦åç¨‹ã€è·å–è¿è¡Œç»“æœå’Œå¼‚å¸¸æ•è·ã€‚
- **åç¨‹å¥æŸ„**ã€‚åç¨‹å¥æŸ„æœ¬è´¨æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œé€šè¿‡åç¨‹å¥æŸ„ç”¨æˆ·å¯ä»¥è®¿é—®å¯¹åº”çš„promiseä»¥åŠæ¢å¤å’Œé”€æ¯åç¨‹ã€‚
- **åç¨‹çŠ¶æ€**ã€‚åç¨‹ä¸ºäº†å®ç°éšæ—¶æš‚åœæ‰§è¡Œå¹¶éšæ„æ¢å¤çš„åŠŸèƒ½ï¼Œå¿…é¡»åœ¨å†…å­˜ç©ºé—´ä¸­ä¿å­˜å½“å‰çš„åç¨‹çŠ¶æ€ï¼Œä¸»è¦æ¶‰åŠåç¨‹å½“å‰è¿è¡Œä½ç½®ï¼ˆä¾¿äºæ¢å¤æ—¶ç»§ç»­è¿è¡Œï¼‰ä»¥åŠç”Ÿå‘½å‘¨æœŸæœªç»“æŸçš„å±€éƒ¨å˜é‡ã€‚

ä¸Šè¿°ä¸‰ç§å¯¹è±¡å¯åˆç§°ä¸ºåç¨‹å¸§ï¼Œå†…å­˜åˆ†å¸ƒå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè¿™ä¹Ÿå¾ˆå¥½çš„è§£é‡Šäº†ä¸ºä»€ä¹ˆåç¨‹å¥æŸ„å’Œpromiseå¯ä»¥äº’ç›¸è½¬æ¢ä»¥åŠå¯ä»¥åˆ©ç”¨åç¨‹å¥æŸ„æ‰§è¡Œåç¨‹çš„æ¢å¤å’Œé”€æ¯ã€‚

![åç¨‹å¸§](./sources/coro_frame.png)

é€šå¸¸æ¿€æ´»å¸§è¢«ç§°ä½œä¸€å—ä¿ç•™äº†å‡½æ•°è¿è¡ŒçŠ¶æ€çš„å†…å­˜ï¼Œå¯¹äºæ™®é€šå‡½æ•°æ¿€æ´»å¸§å°±æ˜¯æ ˆå¸§ï¼Œè€Œå¯¹äºåç¨‹æ¿€æ´»å¸§ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š

- **æ ˆå¸§**ã€‚ä¸æ™®é€šå‡½æ•°æ ˆå¸§ç»“æ„ç±»ä¼¼ï¼Œåœ¨è°ƒç”¨åç¨‹æ—¶äº§ç”Ÿæ ˆå¸§ï¼Œåç¨‹ç»“æŸè¿”å›ç»™è°ƒç”¨è€…æ—¶é‡Šæ”¾æ ˆå¸§ã€‚
- **åç¨‹å¸§**ã€‚ç”¨äºè®°å½•åç¨‹ä¸­é—´çŠ¶æ€ä¾¿äºåç¨‹æš‚åœå’Œæ¢å¤æ‰§è¡Œï¼Œä¸»è¦åŒ…å«ä¸Šè¿°ä»‹ç»çš„ä¸‰ç§ä¸åç¨‹ç›¸å…³çš„æ•°æ®å¯¹è±¡ã€‚å…³äºåç¨‹å¸§æœ‰ä¸¤ç‚¹éœ€è¦æ³¨æ„ï¼š
  - åœ¨åˆ›å»ºåç¨‹æ—¶ç”±ç¼–è¯‘å™¨åˆ†é…å†…å­˜ï¼Œä½†æ³¨æ„è¯¥å†…å­˜éœ€è¦ç”¨æˆ·æ‰‹åŠ¨é‡Šæ”¾ï¼Œå¦åˆ™ä¼šé€ æˆå†…å­˜æ³„æ¼ã€‚
  - é€šå¸¸é‡‡ç”¨å †åˆ†é…æ–¹å¼æ„å»ºåç¨‹å¸§ã€‚c++åç¨‹ææ¡ˆä¸­æœ‰ä¸€äº›è§„å®šï¼Œå¦‚æœç¼–è¯‘å™¨èƒ½å¤Ÿè¯æ˜åç¨‹çš„ç”Ÿå‘½å‘¨æœŸç¡®å®ä¸¥æ ¼åµŒå¥—åœ¨è°ƒç”¨è€…çš„ç”Ÿå‘½å‘¨æœŸå†…ï¼Œåˆ™å…è®¸ä»è°ƒç”¨è€…çš„æ¿€æ´»å¸§ä¸­åˆ†é…åç¨‹å¸§çš„å†…å­˜ã€‚

ç»¼ä¸Šåˆ†æï¼Œè°ƒç”¨è€…è°ƒç”¨åç¨‹ä¼šæ‰§è¡Œå¤§æ¦‚ä¸¤æ­¥ï¼šç¬¬ä¸€æ­¥åƒè°ƒç”¨æ­£å¸¸å‡½æ•°ä¸€æ ·æ„é€ æ ˆå¸§ï¼Œç¬¬äºŒæ­¥ç¼–è¯‘å™¨åˆ†é…å†…å­˜æ„é€ åç¨‹å¸§ã€‚è¿™ä¹Ÿè§£é‡Šäº†ä¸ºä½•C++åç¨‹çš„æ¿€æ´»å¸§ä¼šåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œç¬¬ä¸€æ­¥æ“ä½œç¬¦åˆä¸¥æ ¼åµŒå¥—å…³ç³»æ‰€ä»¥å¯è¢«æ”¾åœ¨æ ˆç©ºé—´ï¼Œç¬¬äºŒæ­¥æ“ä½œä¸ç¬¦åˆä¸¥æ ¼åµŒå¥—æ‰€ä»¥åˆ©ç”¨é¢å¤–çš„å †ç©ºé—´å­˜å‚¨ã€‚

<!-- // FIXME: è¡¨è¿°æ­£ç¡®æ€§
å¦å¤–ï¼Œæœ¬æ–‡ä¼šå°†ä¸¤ä¸ªå…³é”®å­—suspendå’Œæš‚åœè¿›è¡ŒåŒºåˆ†ï¼Œåç¨‹è¿è¡Œè¿‡ç¨‹ä¸­åˆ‡æ¢æ‰§è¡Œæƒå¯ç§°ä¸ºsuspendæˆ–æš‚åœï¼Œä¼¼ä¹åŒºåˆ«ä¸å¤§ï¼Œä½†åç¨‹æ‰§è¡Œå®Œåä¸€å®šä¼šè¢«suspendï¼Œæ­¤æ—¶ç§°ä½œæš‚åœå°±ä¸å¤ªåˆé€‚ï¼Œæ‰€ä»¥è¯»è€…å¯ç†è§£ä¸ºåç¨‹è‡³å°‘ä¼šè¢«suspendä¸€æ¬¡ã€‚ -->

## Promise

å¦‚æœä¸æ·±ç©¶C++åç¨‹çš„æŠ€æœ¯ç»†èŠ‚è€Œä»ç”¨æˆ·ä½¿ç”¨è§’åº¦æ¥è®²çš„è¯åç¨‹å¯è¢«åˆ’åˆ†ä¸ºpromiseå’Œawaiterï¼Œå‰è€…æˆ‘ä»¬æœ‰æ‰€äº†è§£ï¼Œåè€…ä¸»è¦æ˜¯å®ç°åç¨‹è°ƒåº¦é€»è¾‘ã€‚æœ¬å°èŠ‚æˆ‘ä»¬é‡ç‚¹è®²è¿°promiseï¼Œä¸‹é¢ç»™å‡ºä¸€ä¸ªC++åç¨‹çš„æ ·ä¾‹ç¨‹åºï¼ˆ**æ³¨æ„ç¼–è¯‘å™¨ç¼–è¯‘C++åç¨‹ä»£ç éœ€è¦æ·»åŠ -fcoroutines -std=c++20å‚æ•°**ï¼‰ã€‚

```cpp
#include <coroutine>
#include <iostream>
#include <optional>
#include <string>

class Task
{
public:
  class promise_type;
  using handle_type = std::coroutine_handle<promise_type>;
  class promise_type
  {
    friend class Task;

  public:
    Task get_return_object()
    {
      auto handle = handle_type::from_promise(*this);
      return Task(handle);
    }

    constexpr std::suspend_always initial_suspend() { return {}; }

    void return_value(std::string result)
    {
      m_result = result;
    }

    std::suspend_always yield_value(int value)
    {
      m_yield = value;
      return {};
    }

    void unhandled_exception()
    {
      m_exception = std::current_exception();
    }

    constexpr std::suspend_always final_suspend() noexcept { return {}; }

  private:
    std::exception_ptr m_exception{nullptr};
    std::optional<std::string> m_result{std::nullopt};
    std::optional<int> m_yield{std::nullopt};
  };

public:
  Task(const Task &) = delete;

  Task(Task &&other) : m_handle(other.m_handle)
  {
    other.m_handle = nullptr;
  }

  Task &operator=(const Task &other) = delete;

  Task &operator=(Task &&other)
  {
    if (m_handle)
    {
      m_handle.destroy();
    }
    m_handle = other.m_handle;
    other.m_handle = nullptr;
    return *this;
  }

  ~Task()
  {
    m_handle.destroy();
  }

public:
  void resume()
  {
    m_handle.resume();
  }

  std::optional<int> next()
  {
    promise_type &p = m_handle.promise();
    p.m_yield = std::nullopt;
    p.m_exception = nullptr;
    if (!m_handle.done())
    {
      m_handle.resume();
    }
    if (p.m_exception)
    {
      std::rethrow_exception(p.m_exception);
    }
    return p.m_yield;
  }

  std::optional<std::string> result()
  {
    return m_handle.promise().m_result;
  }

private:
  Task(handle_type handle) : m_handle(handle) {}

private:
  handle_type m_handle;
};

Task run(int i)
{
  std::cout << "task " << i << " start" << std::endl;
  co_yield 1;
  for (int i = 2; i <= 5; i++)
  {
    co_yield i;
  }
  std::cout << "task " << i << " end" << std::endl;
  co_return "task run finish";
}

int main(int argc, char const *argv[])
{
  /* code */
  auto task = run(5);
  std::optional<int> val;
  while ((val = task.next()))
  {
    std::cout << "get yield value: " << (*val) << std::endl;
  }
  std::cout << "get return value: " << (*task.result()) << std::endl;
  return 0;
}
```

è¯¥ç¨‹åºæ¼”ç¤ºäº†é™¤äº†awaiterä¹‹å¤–å¤§éƒ¨åˆ†çš„C++åç¨‹çŸ¥è¯†ç‚¹ï¼Œè¿è¡Œç»“æœå¦‚ä¸‹ï¼š

```txt
task 5 start
get yield value: 1
get yield value: 2
get yield value: 3
get yield value: 4
get yield value: 5
task 5 end
get return value: task run finish
```

ä¸‹é¢æˆ‘ä»¬ä¸€æ­¥æ­¥å¯¹è¿™ä¸ªç¨‹åºè¿›è¡Œå‰–æã€‚

### run:åŒ–èº«ä¸ºåç¨‹çš„å‡½æ•°

æ ·ä¾‹ä¸­çš„runå‡½æ•°å› ä¸ºåœ¨å‡½æ•°ä½“åŒ…å«äº†åç¨‹å…³é”®å­—ï¼Œæ‰€ä»¥è¢«å½“ä½œåç¨‹å¤„ç†ï¼Œå…¶è¿”å›å€¼ä¹Ÿè¾ƒä¸ºç‰¹æ®Šï¼Œå¹¶éä¸returnè¯­å¥è¿”å›å€¼çš„ç±»å‹ä¸€è‡´ï¼Œè€Œæ˜¯ä¸€ä¸ªç”¨æˆ·è‡ªå®šä¹‰çš„ç±»ï¼Œæ³¨æ„è¿™æ˜¯C++åç¨‹çš„è§„å®šã€‚

### UserFacing:é¢å‘ç”¨æˆ·çš„å¯¹è±¡

è¯»è€…åº”è¯¥æ³¨æ„åˆ°æ ·ä¾‹ç¨‹åºå®šä¹‰äº†ä¸€ä¸ªTaskç±»å¹¶ä¸”runåç¨‹è¿”å›å€¼ä¹Ÿæ˜¯Taskç±»å‹ã€‚è¯»è€…å¯ä»¥ç†è§£ä¸ºè¿™æ˜¯C++åç¨‹è§„å®šç”¨æˆ·éœ€è¦å®šä¹‰çš„å¯¹è±¡ï¼ˆåç»­ç”¨UserFacingä»£æŒ‡ï¼‰ï¼Œå› ä¸ºå¯¹è¯¥ç±»æ— ç±»æ–¹æ³•ä¸Šçš„é™åˆ¶ï¼Œä»…éœ€è¦æä¾›è¯¥ç±»çš„promise_typeï¼Œæ»¡è¶³è¯¥å®šä¹‰åä¾¿å¯ä»¥ä½œä¸ºåç¨‹å‡½æ•°çš„è¿”å›å€¼ï¼Œ**æ³¨æ„åç¨‹å‡½æ•°å¿…é¡»ä»¥æ»¡è¶³è¯¥å®šä¹‰çš„ç±»å‹ä½œä¸ºè¿”å›å€¼**ã€‚

```cpp
class UserFacing
{
public:
  class promise_type; // UsingFacingéœ€è¦æ»¡è¶³çš„é™åˆ¶
};

UserFacing coro() // åç¨‹è¿”å›å€¼è¾ƒä¸ºç‰¹æ®Šï¼Œå¿…é¡»æ˜¯UserFacingç±»å‹
{
  // coding .....
  co_return;
}
```

æ³¨æ„åœ¨åç¨‹ä¸­ä¸ºUserFacingæŒ‡å®špromise_typeç±»å‹æœ‰å¦‚ä¸‹ä¸‰ç§æ–¹å¼ï¼ˆæ‰€æœ‰æ–¹å¼éƒ½å¿…é¡»è®©promise_typeå¯¹å¤–éƒ¨å¯è§ï¼Œå³è®¿é—®ä¿®é¥°ç¬¦ä¸ºpublicï¼‰ï¼š

```cpp
// 1. å°†promise_typeçš„å®šä¹‰æ”¾åˆ°UserFacingé‡Œ
class UserFacing
{
public:
  class promise_type{

  };
};

//2. æŒ‡å®špromise_typeä¸ºå¤–éƒ¨çš„ä¸€ä¸ªç±»
class promise{};
class UserFacing{
public:
  using promise_type = promise;
};

// 3. åˆ©ç”¨coroutine_traitsæŒ‡å®šUserFacingçš„promise_typeï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰ã€‚
// å…¶å®ç¼–è¯‘å™¨å¤„ç†åç¨‹æ—¶å°±æ˜¯é€šè¿‡coroutine_traitsæ¨¡æ¿æ¥å¯»æ‰¾
// UserFacingçš„promise_typeï¼Œè¯¥æ¨¡æ¿é»˜è®¤æ˜¯æœŸæœ›é€šè¿‡
// UserFacing::promise_typeæ¥è·å–promiseç±»å‹ï¼Œå‡å¦‚æˆ‘ä»¬ä¸æƒ³
// åœ¨UserFacingç±»å‹ä¸­æ·»åŠ promise_typeä¾¿å¯ä»¥é€šè¿‡ç‰¹åŒ–coroutine_traitsæ¥æŒ‡å®šã€‚
class promise;
class UserFacing;
template <>
struct std::coroutine_traits<UserFacing> {
    using promise_type = promise;
};
```

ä¸Šè¿°æåˆ°çš„ç¬¬ä¸‰ç§æ–¹æ³•å³ä½¿ç”¨coroutine_traitsçš„ä¼˜ç‚¹æœ‰ä¸¤ç§ï¼š

- **UserFacingæ˜¯ä¸€ä¸ªæˆ‘ä»¬æ— æ³•ä¿®æ”¹çš„ç±»**ã€‚æ¯”å¦‚æˆ‘ä»¬å¯ä»¥æŒ‡å®šä¸€ä¸ªC++æ ‡å‡†åº“çš„ç±»ä¸ºUserFacingï¼Œç”šè‡³æ˜¯intï¼Œè¿™åªéœ€è¦æˆ‘ä»¬ç‰¹åŒ–coroutine_traitsæ¨¡æ¿ä¸ºè¯¥ç±»å‹æŒ‡å®špromise_typeå³å¯ã€‚
- **coroutine_traitså¯ä»¥æä¾›æ›´ç»†è‡´çš„promiseç±»å‹æŒ‡å®š**ã€‚

ä¸Šè¿°ç¬¬äºŒç‚¹éœ€è¦ä»åç¨‹å‚æ•°æ¥ç†è§£ï¼ˆæ³¨æ„C++åç¨‹çš„å‚æ•°ä¸æ™®é€šå‡½æ•°çš„å‚æ•°æ²¡æœ‰å·®åˆ«ï¼‰ï¼Œå‡è®¾æˆ‘ä»¬æœ‰å››ä¸ªrunåç¨‹å‚æ•°ä¸ä¸€è‡´ï¼Œå¦‚ä¸‹ï¼š

```cpp
UserFacing run(){ // 1å·åç¨‹
  // code
  // ...
  co_return;
}
UserFacing run(int x, float y){ // 2å·åç¨‹
  // code
  // ...
  co_return;
}
UserFacing run(int x, char y){ // 3å·åç¨‹
  // code
  // ...
  co_return;
}
UserFacing run(int x, double y){ // 4å·åç¨‹
  // code
  // ...
  co_return;
}
```

æˆ‘ä»¬ç°åœ¨æœ‰ä¸ªéœ€æ±‚ï¼Œä¸º1å·åç¨‹æŒ‡å®šå…³è”çš„promise_typeä¸ºpromise1ï¼Œ2å·åç¨‹å…³è”promise2ï¼Œå…¶ä½™åç¨‹å…³è”promise3ï¼Œè¿™ä¸ªéœ€æ±‚æ˜¾ç„¶æ— æ³•é€šè¿‡åœ¨UserFacingç±»é‡ŒæŒ‡å®špromise_typeæ¥è§£å†³ï¼Œä½†å¯ä»¥ä½¿ç”¨coroutine_traitsè½»æ¾åº”å¯¹ï¼Œå¦‚ä¸‹ï¼š

```cpp
template <>
struct std::coroutine_traits<UserFacing> { // çº¦æŸ1
    using promise_type = promise1;
};

template <>
// æ¨¡æ¿å‚æ•°ä¸­ç¬¬äºŒä¸ªä»¥åŠä¹‹åçš„å‚æ•°å‡ä¸ºåç¨‹å‚æ•°ç±»å‹
struct std::coroutine_traits<UserFacing,int,float> { // çº¦æŸ2
    using promise_type = promise2;
};

template <typename... ArgTypes>
struct std::coroutine_traits<UserFacing, ArgTypes...> { // çº¦æŸ3
  using promise_type = promise3;
};
```

çº¦æŸ1è¡¨ç¤ºä»»ä½•è¿”å›å€¼ä¸ºUserFacingä¸”å‚æ•°ä¸ºç©ºçš„åç¨‹å…³è”çš„promise_typeä¸ºpromise1ï¼Œçº¦æŸ2è¡¨ç¤ºä»»ä½•è¿”å›å€¼ä¸ºUserFacingä¸”å‚æ•°æŒ‰é¡ºåºä¸ºintå’Œfloatçš„åç¨‹å…³è”çš„promise_typeä¸ºpromise2ï¼Œçº¦æŸ3ä½¿ç”¨å˜å‚æ¨¡æ¿è¡¨ç¤ºä»»ä½•è¿”å›å€¼ä¸ºUserFacingä¸”å‚æ•°ä»»æ„æˆ–è€…ä¸ºç©ºçš„åç¨‹å…³è”çš„promise_typeä¸ºpromise3ã€‚å…³äºä¸Šè¿°coroutine_traitsçš„ä½¿ç”¨æœ‰ä¸¤ç‚¹éœ€è¦æ³¨æ„ï¼š

- å¦‚æœåç¨‹ä¸æŸä¸€ä¸ªcoroutine_traitsçº¦æŸç›¸åŒ¹é…ï¼Œé‚£ä¹ˆè¯¥åç¨‹è¿”å›ç±»å‹å†…éƒ¨å³ä½¿å®šä¹‰äº†promise_typeä¹Ÿä¸å†èµ·ä½œç”¨ã€‚
- ä¾æ®C++æ¨¡æ¿çš„åŒ¹é…è§„åˆ™å˜å‚æ¨¡æ¿çš„åŒ¹é…ä¼˜å…ˆçº§é åã€‚ä¾‹å¦‚åç¨‹2æ—¢æ»¡è¶³çº¦æŸ2åˆæ»¡è¶³çº¦æŸ3ï¼Œä½†çº¦æŸ2ä¼šè¢«ä¼˜å…ˆåŒ¹é…åˆ°ã€‚

> **ğŸ’¡ä¸ºä½•C++åç¨‹éœ€è¦å•ç‹¬å®šä¹‰ä¸€ä¸ªé¢å‘ç”¨æˆ·çš„å¯¹è±¡**ï¼Ÿ
> å› ä¸ºç¼–è¯‘å™¨å¯¹promiseåšäº†è¯¸å¤šé™åˆ¶ï¼Œä¸”promiseæŒæœ‰åç¨‹è¿è¡Œçš„æ•°æ®ï¼Œè€Œé¢å‘ç”¨æˆ·çš„å¯¹è±¡å¯ä»¥è®©ç”¨æˆ·è‡ªå®šä¹‰å¦‚ä½•å»æ“ä½œpromiseçš„æ•°æ®ï¼Œæ•°æ®ä¸å¤„ç†é€»è¾‘åˆ†ç¦»å¼€æ¥ç®—æ˜¯è®¾è®¡ä¸Šçš„è§£è€¦ã€‚
> ä»åç»­å­¦ä¹ ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°åç¨‹æœ¬èº«æ˜¯éœ€è¦å­˜å‚¨çŠ¶æ€ä»¥åŠæ•°æ®çš„ï¼ŒUserFacingåƒæ˜¯ä¸ºè°ƒç”¨è€…æä¾›äº†ä¸€ä¸ªå…¥å£æ¥æ“çºµåç¨‹ã€‚

### coroutine_handle:å¤–éƒ¨ç”¨ä»¥æ“ä½œåç¨‹çš„å¥æŸ„

coroutine_handleæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œä¸€èˆ¬æ˜¯é€šè¿‡è°ƒç”¨promiseçš„æ–¹æ³•è·å¾—ï¼Œé€šè¿‡ä¸ŠèŠ‚çš„åˆ†æè¯»è€…åº”è¯¥ç†è§£äº†ä¸ºä½•coroutine_handleå¯ä»¥å’Œpromiseäº’ç›¸è½¬åŒ–ï¼Œå½“ç”¨æˆ·æ‹¿åˆ°åç¨‹å¥æŸ„åå¯ä»¥ä½¿ç”¨ä¸‹è¿°æ–¹æ³•æ“ä½œåç¨‹ï¼š

- **handle.promise()**ã€‚é€šè¿‡è¯¥æ–¹æ³•å¯ä»¥ä»åç¨‹å¥æŸ„è·å–promiseã€‚
- **handle.done()**ã€‚è¯¥æ–¹æ³•ç”¨äºåˆ¤å®šåç¨‹æ˜¯å¦æ‰§è¡Œç»“æŸã€‚
- **handle.resume()**ã€‚è¯¥æ–¹æ³•å¯ä»¥ä½¿æš‚åœçš„åç¨‹ç»§ç»­è¿è¡Œï¼Œæ³¨æ„å¦‚æœæ­¤æ—¶handleå…³è”çš„åç¨‹æ‰§è¡Œç»“æŸï¼Œè°ƒç”¨è¯¥æ–¹æ³•ä¼šäº§ç”Ÿcore dumpã€‚
- **handle.destroy()**ã€‚è¯¥æ–¹æ³•è´Ÿè´£åç¨‹å¸§å†…å­˜çš„å›æ”¶ï¼Œç”¨æˆ·éœ€è¦é¿å…é‡å¤è°ƒç”¨ã€‚

åœ¨ä½¿ç”¨ä¸Šcoroutine_handleæ˜¯ä¸€ä¸ªç±»æ¨¡æ¿ï¼Œå®šä¹‰å¦‚ä¸‹ï¼Œç±»æ¨¡æ¿å‚æ•°ä¸ºpromise_typeã€‚

```cpp
template <typename _Promise = void>
    struct coroutine_handle;
```

ç”¨æˆ·ä¹Ÿå¯ç›´æ¥ä½¿ç”¨coroutine_handle<>å³æ¨¡æ¿å‚æ•°é»˜è®¤ä¸ºç©ºï¼Œè¿™ç±»ä¼¼äºvoid*æŒ‡é’ˆï¼Œå¯ç”¨äºå­˜å‚¨ä»»æ„ç±»å‹çš„promiseï¼Œä½†æ­¤æ—¶æ— æ³•è°ƒç”¨handle.promise()æ–¹æ³•ï¼Œç”¨æˆ·è‹¥æƒ³è·å–å­˜å‚¨çš„promiseéœ€è¦ä½¿ç”¨ç±»å‹è½¬æ¢ã€‚

```cpp
coroutine_handle<promise_type> handle = ... // è·å–handleã€‚
auto& p = handle.promise(); // pæ­¤æ—¶ä¸ºpromise_type&ç±»å‹ã€‚

coroutine_handle<> handle = ... // è·å–handleã€‚
// auto& p = handle.promise(); // æŠ¥é”™ï¼Œå› ä¸ºä¸å­˜åœ¨promiseæ–¹æ³•ã€‚
auto specific_handle = std::coroutine_handle<promise_type>::from_address(handle.address()); // ç±»å‹è½¬æ¢
auto& p = specific_handle.promise(); // pæ­¤æ—¶ä¸ºpromise_type&ç±»å‹ã€‚

```

### promise:åç¨‹çš„æ ¸å¿ƒ

<!-- TODO -->
promiseä½œä¸ºC++åç¨‹çš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼Œæ— è®ºæ˜¯ç”¨æˆ·è¿˜æ˜¯ç¼–è¯‘å™¨éƒ½

#### promiseçš„æ„é€ 

å½“ç”¨æˆ·è°ƒç”¨ä¸€ä¸ªåç¨‹æ—¶ï¼Œç¼–è¯‘å™¨ä¼šå¯»æ‰¾è¯¥åç¨‹ç»‘å®šçš„promise_typeï¼Œç„¶ååˆ†é…åç¨‹å¸§å¹¶å°†promise_typeå¯¹åº”çš„promiseå¯¹è±¡æ„é€ åœ¨åç¨‹å¸§ä¸Šï¼Œæ­¤è¿‡ç¨‹æ¶‰åŠåˆ°promiseæ„é€ å‡½æ•°çš„é€‰å–ã€‚

å®é™…ä¸ŠC++åç¨‹ä¸ºæ„é€ promiseå¯¹è±¡æä¾›äº†å¾ˆå¤§çš„çµæ´»æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºpromiseç±»æŒ‡å®šå¤šä¸ªæ„é€ å‡½æ•°ï¼Œè€Œç¼–è¯‘å™¨ä¼šæŒ‰ç…§å¦‚ä¸‹é¡ºåºé€‰æ‹©æ„é€ å‡½æ•°ï¼š

1. å¦‚æœåç¨‹çš„å‚æ•°åˆ—è¡¨ä¸promiseçš„æŸä¸€æ„é€ å‡½æ•°çš„å‚æ•°åˆ—è¡¨ç›¸åŒ¹é…ï¼ˆä¸ç”¨å®Œå…¨åŒ¹é…ï¼Œç›¸åŒä½ç½®ä¸åŒç±»å‹åªè¦å¯è½¬æ¢å³å¯ï¼‰ï¼Œåˆ™é€‰æ‹©è¯¥æ„é€ å‡½æ•°ã€‚
2. æ­¥éª¤1åŒ¹é…å¤±è´¥ï¼Œæ­¤æ—¶å¦‚æœpromiseå­˜åœ¨å‚æ•°ä¸ºç©ºçš„æ„é€ å‡½æ•°ï¼Œåˆ™é€‰æ‹©è¯¥æ„é€ å‡½æ•°ã€‚
3. æ­¥éª¤2åŒ¹é…å¤±è´¥ï¼Œæ­¤æ—¶ç¼–è¯‘æŠ¥é”™ã€‚

æ ·ä¾‹ç¨‹åºçš„runåç¨‹å‚æ•°åˆ—è¡¨ä¸ºç©ºï¼ŒæŒ‰è§„åˆ™åº”è¯¥åŒ¹é…å‚æ•°ä¸ºç©ºçš„promiseæ„é€ å‡½æ•°ï¼Œè€Œç¼–è¯‘å™¨ç”Ÿæˆçš„é»˜è®¤æ„é€ å‡½æ•°ç¬¦åˆè¦æ±‚ã€‚

>**ğŸ’¡C++åç¨‹è®¾è®¡ä¸ºä½•è¦å°†åç¨‹çš„å‚æ•°åˆ—è¡¨ä¸promiseæ„é€ å‡½æ•°å…³è”èµ·æ¥**ï¼Ÿ
>å› ä¸ºåç¨‹ä¸ä»…å¯ä»¥æ˜¯æ™®é€šå‡½æ•°ï¼Œè¿˜å¯ä»¥æ˜¯ç±»çš„æˆå‘˜å‡½æ•°ã€‚è¯»è€…åº”è¯¥äº†è§£C++ä¸­å¯¹è±¡è°ƒç”¨æˆå‘˜å‡½æ•°éƒ½ä¼šéšå¼çš„ä¼ é€’thisæŒ‡é’ˆï¼Œè€Œåœ¨ç¼–è¯‘å™¨è§†è§’çœ‹æˆå‘˜å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¹Ÿæ˜¯ç±»æŒ‡é’ˆï¼Œç”¨æˆ·ä¸éœ€è¦æ˜¾å¼çš„æ·»åŠ ã€‚
>
>åŒç†ï¼Œåç¨‹ä½œä¸ºæˆå‘˜å‡½æ•°æ—¶å‚æ•°åˆ—è¡¨ä¹Ÿä¸éœ€è¦æ·»åŠ ç±»æŒ‡é’ˆï¼Œä½†æ­¤æ—¶ç¼–è¯‘å™¨æ„é€ åç¨‹å¯¹è±¡ä¼šä¼ é€’thisæŒ‡é’ˆï¼Œæ‰€ä»¥promiseçš„æ„é€ å‡½æ•°å‚æ•°éœ€è¦å¸¦æœ‰ç±»æŒ‡é’ˆï¼Œè¿™æ ·åç¨‹è¿è¡Œè¿‡ç¨‹ä¸­æ‰å¯ä»¥é€šè¿‡ç±»æŒ‡é’ˆè®¿é—®ç±»æˆå‘˜å’Œæ–¹æ³•ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š
>
>```cpp
>class A;
>class UserFacing{
>public:
>  class promise_type{
>  public:
>    promise_type(A* p,int x);
>    // ignore other functions...
>  private:
>    A* p;
>  };
>};
>
>class A{
>public:
>  UserFacing run(int x){
>    // code
>    // ...
>    co_return;
>  }
>};
>```
>
>ä¸Šè¿°promise_typeçš„æ„é€ å‡½æ•°ä¹Ÿå¯ä»¥å†™æˆä¸‹è¿°å½¢å¼æ¥æ”¶ä»»æ„å‚æ•°ç±»å‹ï¼š
>
>```cpp
>template <typename... ArgTypes>
>promise_type::promise_type(A* p, ArgTypes... args);
>```

#### get_return_object

>```cpp
>// å‡½æ•°åŸå‹
>UserFacing promise::get_return_object();
>```

ç”¨æˆ·è°ƒç”¨åç¨‹æ—¶è·å–çš„UserFacingå¯¹è±¡æ˜¯ç¼–è¯‘å™¨é€šè¿‡promiseçš„get_return_objectå‡½æ•°æ„é€ å‡ºæ¥çš„ï¼Œè¯¥å‡½æ•°å‚æ•°ä¸ºç©ºï¼Œè¿”å›ç±»å‹éœ€è¦ä¸åç¨‹çš„è¿”å›ç±»å‹ä¸€è‡´ã€‚

æ³¨æ„æ ·ä¾‹ç¨‹åºä¸­è¯¥å‡½æ•°è°ƒç”¨äº†æ ‡å‡†åº“æä¾›çš„ä¸€ä¸ªæ–¹æ³•ï¼š

```cpp
// ...
auto handle = handle_type::from_promise(*this);
// ...
```

é€šè¿‡è°ƒç”¨std::coroutine_handle<promise_type>::from_promise(promise_type&)æ–¹æ³•å¹¶ä¼ å…¥promise_typeå¯¹è±¡çš„å¼•ç”¨ï¼ˆå¼•ç”¨ç±»å‹éœ€è¦ä¸æ–¹æ³•çš„æ¨¡æ¿å‚æ•°ä¿æŒä¸€è‡´ï¼‰å¯ä»¥è·å¾—promiseå¯¹è±¡å¯¹åº”çš„coroutine_handleï¼Œé€šå¸¸çš„åšæ³•ä¼šå°†coroutine_handleä½œä¸ºUserFacingdæ„é€ å‡½æ•°çš„å‚æ•°ï¼Œè¿™æ ·UserFacingä¾¿å¯ä»¥è®¿é—®promiseæŒæœ‰çš„æ•°æ®ï¼ˆæ³¨æ„è®¾ç½®promiseæ•°æ®å’Œæ–¹æ³•å¯¹UserFacingçš„è®¿é—®å¯è§æ€§ï¼‰ã€‚

#### initial_suspend

>```cpp
>// å‡½æ•°åŸå‹
>awaiter promise::initial_suspend();
>```

å‰æ–‡æˆ‘ä»¬æåˆ°C++ä¸ºåç¨‹è®¾è®¡äº†å¤šä¸ªè°ƒåº¦ç‚¹ï¼Œç¬¬ä¸€ä¸ªè°ƒåº¦ç‚¹ä¾¿æ˜¯åœ¨åç¨‹åˆ›å»ºæ—¶ï¼Œç”±initial_suspendæ–¹æ³•å®ç°è°ƒåº¦é€»è¾‘ã€‚

å½“ç”¨æˆ·è°ƒç”¨åç¨‹å¹¶æ„é€ å®Œåç¨‹å¸§åï¼Œç¼–è¯‘å™¨ä¼šè°ƒç”¨åç¨‹å…³è”çš„promiseå¯¹è±¡çš„initial_suspendæ–¹æ³•é€šè¿‡è¿”å›çš„awaiteræ¥å†³å®šæ˜¯ç›´æ¥è¿è¡Œåç¨‹è¿˜æ˜¯æš‚åœæ‰§è¡Œè½¬ç§»æ§åˆ¶æƒï¼Œæ¯”å¦‚ç”¨æˆ·æƒ³åœ¨åˆ›å»ºåç¨‹ååšä¸€äº›å¼‚æ­¥çš„å‡†å¤‡å·¥ä½œï¼Œæ­¤æ—¶å¯ä»¥æš‚åœæ‰§è¡Œç­‰å‡†å¤‡å·¥ä½œå®Œæˆåå†å›å¤åç¨‹çš„æ‰§è¡Œã€‚awaiterçš„å…·ä½“ç»†èŠ‚æš‚æœªè®²åˆ°ï¼Œä½†è¯»è€…åªéœ€è¦çŸ¥é“C++å®˜æ–¹æä¾›äº†é»˜è®¤çš„awaiterå®ç°ï¼š

- **std::suspend_alaways**ã€‚æš‚åœåç¨‹æ‰§è¡Œï¼Œæ‰§è¡Œæƒè¿”å›ç»™è°ƒç”¨è€…ã€‚
- **std::suspend_never**ã€‚åç¨‹ç»§ç»­æ‰§è¡Œã€‚

æ ·ä¾‹ç¨‹åºè¿”å›std::suspend_alawaysæ¥æ§åˆ¶åç¨‹åˆ›å»ºåä¸ä¼šç«‹åˆ»æ‰§è¡Œã€‚

>**ğŸ’¡ä¸ºä½•æ ·ä¾‹ç¨‹åºçš„initial_suspendå‡½æ•°å‰è¦æ·»åŠ constexpr**ï¼Ÿ
>std::suspend_alawayså’Œstd::suspend_neveréƒ½æ˜¯éå¸¸ç®€å•ä¸”å«ä¹‰ååˆ†å›ºå®šæ˜ç¡®çš„awaiterï¼Œæ‰€ä»¥æˆå‘˜å‡½æ•°å‡æœ‰constexpré™åˆ¶ï¼Œå¦‚æœinitial_suspendå‡½æ•°ç›´æ¥è¿”å›äºŒè€…å…¶ä¸€çš„è¯ä¹Ÿå¯ä»¥æ·»åŠ constexpræ–¹ä¾¿ç¼–è¯‘å™¨åšä¼˜åŒ–ï¼Œå…¶ä»–å‡½æ•°ä¹ŸåŒç†ã€‚

#### final_suspend

>```cpp
>// å‡½æ•°åŸå‹
>awaiter promise::final_suspend();
>```

ä¸initial_suspendç±»ä¼¼ï¼Œfinal_suspendå‡½æ•°è´Ÿè´£åç¨‹æ‰§è¡Œç»“æŸåçš„è°ƒåº¦ç‚¹é€»è¾‘ï¼Œè¿”å›å€¼åŒæ ·æ˜¯awaiterç±»å‹ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡è‡ªå®šä¹‰awaiteræ¥è½¬ç§»æ‰§è¡Œæƒï¼Œä¹Ÿå¯ä»¥ç›´æ¥è¿”å›std::suspend_alawaysæˆ–è€…std::suspend_neverï¼Œä¸è¿‡ç¼–è¯‘å™¨åœ¨è°ƒç”¨final_suspendå‡½æ•°æ—¶ä¼šæ‰§è¡Œä¸‹åˆ—ä¼ªä»£ç ï¼š

```cpp
co_await p.final_suspend();
destruct promise p
destruct parameters in coroutine frame
destroy coroutine state
```

æ¢å¥è¯è¯´ï¼Œå¦‚æœfinal_suspendè¿”å›äº†suspend_neverï¼Œé‚£ä¹ˆç¼–è¯‘å™¨ä¼šæ¥ç€æ‰§è¡Œåç»­çš„èµ„æºæ¸…ç†æ“ä½œï¼Œå¦‚æœUserFacingåœ¨ææ„å‡½æ•°ä¸­å†æ¬¡æ‰§è¡Œhandle.destroyï¼Œé‚£ä¹ˆä¼šå‡ºç°core dumpï¼Œæ‰€ä»¥ä¸€èˆ¬å»ºè®®ä¸è¦è¿”å›suspend_neverï¼Œå› ä¸ºèµ„æºçš„é‡Šæ”¾æœ€å¥½åœ¨ç”¨æˆ·ä¾§æ¥åšã€‚

<!-- æ³¨æ„å› ä¸ºfinal_suspendçš„å­˜åœ¨ï¼Œæ‰€ä»¥åç¨‹åœ¨æ•´ä¸ªè¿è¡Œè¿‡ç¨‹ä¸­è‡³å°‘è¢«suspendï¼ˆè½¬ç§»æ‰§è¡Œæƒï¼‰ä¸€æ¬¡ï¼Œè€ŒUserFacingå¯¹è±¡æ­£æ˜¯åœ¨åç¨‹ç¬¬ä¸€æ¬¡è¢«suspendæ—¶è¿”å›ç»™è°ƒç”¨è€…ã€‚ -->

#### co_return & return_value

>```cpp
>// å‡½æ•°åŸå‹
>co_return T;
>void promise::return_value(T);
>
>co_return;
>void promise::return_void();
>```

åç¨‹çš„co_returnå°±åƒæ™®é€šå‡½æ•°çš„returnä¸€æ ·ï¼Œç”¨äºç»ˆæ­¢åç¨‹å¹¶é€‰æ‹©æ€§çš„è¿”å›å€¼ã€‚æ ¹æ®co_returnæ˜¯å¦è¿”å›å€¼ï¼Œç¼–è¯‘å™¨ä¼šåšå‡ºä¸åŒçš„å¤„ç†ï¼š

- **ä¸è¿”å›å€¼**ã€‚æ­¤æ—¶co_returnä»…ç”¨äºç»ˆæ­¢åç¨‹æ‰§è¡Œï¼Œç¼–è¯‘å™¨éšåè°ƒç”¨promise.return_voidæ–¹æ³•ï¼Œæ­¤å‡½æ•°å¯å®ç°ä¸ºç©ºï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ä¹Ÿå¯ä»¥æ‰§è¡Œåç¨‹ç»“æŸåçš„æ¸…ç†å·¥ä½œï¼Œä½†ç”¨æˆ·å¿…é¡»ä¸ºpromiseå®šä¹‰return_voidæ–¹æ³•ã€‚
- **è¿”å›å€¼**ã€‚å‡è®¾co_returnè¿”å›å€¼çš„ç±»å‹ä¸ºTï¼Œæ­¤æ—¶ç¼–è¯‘å™¨è°ƒç”¨promise.return_valueæ–¹æ³•ï¼Œå¹¶å°†co_returnçš„è¿”å›å€¼ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œ**ç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰return_valueå‡½æ•°çš„å‚æ•°ç±»å‹**ï¼Œå°±åƒè°ƒç”¨æ­£å¸¸å‡½æ•°ä¸€æ ·ï¼Œåªè¦Tå¯ä»¥è½¬æ¢ä¸ºè¯¥å‚æ•°ç±»å‹å³å¯ã€‚æ ·ä¾‹ç¨‹åºä¸­å› ä¸ºco_returnè¿”å›äº†å€¼ï¼Œæ‰€ä»¥promise_typeä¹Ÿå¢æ·»äº†ä¸€ä¸ªæˆå‘˜å‡½æ•°ç”¨äºå­˜å‚¨è¯¥å€¼ï¼Œåœ¨return_valueå‡½æ•°ä½“å†…å®Œæˆèµ‹å€¼ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯C++æ ‡å‡†è§„å®šreturn_valueå’Œreturn_voidå‡½æ•°ä¸èƒ½åŒæ—¶å­˜åœ¨ï¼Œå¹¶ä¸”å½“åç¨‹ä¸å­˜åœ¨co_returnå…³é”®å­—æ—¶ç”¨æˆ·ä¹Ÿéœ€è¦å®šä¹‰return_voidæ–¹æ³•ï¼Œå› ä¸ºåç¨‹æ‰§è¡Œç»“æŸåç¼–è¯‘å™¨ä¼šéšå¼è°ƒç”¨è¯¥å‡½æ•°ã€‚

é€šè¿‡ä¸Šè¿°åˆ†ææˆ‘ä»¬å‘ç°åç¨‹è¿”å›å€¼ä¸æ™®é€šå‡½æ•°è¿”å›å€¼çš„å¤„ç†ä¸ä¸€è‡´ã€‚æ™®é€šå‡½æ•°è¿”å›å€¼æ—¶è°ƒç”¨æ–¹å¯ä»¥ç›´æ¥æ‹¿åˆ°å€¼ï¼Œä½†è°ƒç”¨åç¨‹æ—¶è°ƒç”¨æ–¹æ‹¿åˆ°çš„æ˜¯UserFacingå¯¹è±¡ï¼Œé‚£æ€ä¹ˆæ‹¿åˆ°åç¨‹co_returnçš„å€¼å‘¢ï¼Ÿä¸€èˆ¬çš„é€»è¾‘æ˜¯åœ¨promiseä¸­å¢åŠ ä¸€ä¸ªæˆå‘˜å˜é‡å¹¶åœ¨return_valueå‡½æ•°ä¸­ä¸ºå…¶èµ‹å€¼ï¼Œco_returnååç¨‹æ‰§è¡Œç¡®å®ç»“æŸäº†ï¼Œä½†åç¨‹å¸§å¹¶ä¸ä¼šè‡ªåŠ¨å›æ”¶ï¼Œpromiseå¯¹è±¡ä¾ç„¶å­˜åœ¨ï¼Œç”¨æˆ·å¯ä»¥åœ¨UserFacingä¸­æ·»åŠ è·å–è¯¥å€¼çš„æ–¹æ³•ï¼ŒUserFacingä¸€èˆ¬å­˜å‚¨äº†promiseçš„coroutine_handleï¼Œé€šè¿‡è¯¥handleè®¿é—®promiseçš„æˆå‘˜å˜é‡ã€‚

#### co_yield & yield_value

>```cpp
>// å‡½æ•°åŸå‹
>co_yield T;
>awaiter promise::yield_value(T);
>```

co_yieldç”¨äºåç¨‹åœ¨è¿è¡Œè¿‡ç¨‹ä¸­å‘å¤–è¾“å‡ºå€¼ã€‚ä¸co_returnç±»ä¼¼ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦åœ¨promiseä¸­ä¸ºå…¶æ–°å¢æˆå‘˜å˜é‡ï¼Œå½“æ‰§è¡Œåˆ°co_yieldè¯­å¥æ—¶ï¼Œç¼–è¯‘å™¨è°ƒç”¨yield_valueæ–¹æ³•ï¼Œco_yieldçš„å€¼ä½œä¸ºå‚æ•°ï¼Œå‡½æ•°ä½“å†…å°†è¯¥å€¼èµ‹äºˆç»™promiseæˆå‘˜å˜é‡ã€‚å¤–éƒ¨è®¿é—®è¯¥co_yieldçš„å€¼çš„æµç¨‹ä¸co_returnç±»ä¼¼ã€‚

ä¸co_returnä¸åŒçš„æ˜¯ï¼Œco_yieldä¹‹ååç¨‹çš„è¿è¡Œå¹¶ä¸ä¸€å®šç»“æŸï¼Œæ‰€ä»¥yield_valueé€šè¿‡è¿”å›awaiterç±»å‹æ¥å†³å®šåç¨‹çš„æ‰§è¡Œæƒå¦‚ä½•å¤„ç†ï¼Œä¸€èˆ¬è¿”å›std::suspend_alawaysè½¬ç§»æ§åˆ¶æƒåˆ°è°ƒç”¨è€…ä½¿å¾—co_yieldçš„å€¼å¾—åˆ°å¤„ç†ï¼Œç”¨æˆ·ä¹Ÿå¯è¿”å›è‡ªå®šä¹‰çš„awaiterï¼Œä½†é€šå¸¸ä¸è¦è¿”å›std::suspend_neverç­‰è®©åç¨‹ç»§ç»­è¿è¡Œçš„awaiterï¼Œå› ä¸ºæ­¤æ—¶åç¨‹ç»§ç»­è¿è¡Œçš„è¯å¦‚æœå†æ¬¡ç¢°åˆ°co_yieldé‚£ä¹ˆä¸Šæ¬¡yieldçš„å€¼å°±ä¼šè¢«è¦†ç›–ã€‚

åç¨‹ä½“å†…é€šå¸¸ä¼šæ‰§è¡Œå¤šæ¬¡co_yieldï¼Œä¸ºäº†è®©ç”¨æˆ·èƒ½åƒä½¿ç”¨è¿­ä»£å™¨ä¸€æ ·è·å–co_yieldçš„å€¼ï¼Œæ ·ä¾‹ç¨‹åºä¸ºTaskç±»å®šä¹‰çš„nextæ¥å£å®ç°ç¨å¾®å¤æ‚ä¸€äº›ï¼Œæµç¨‹å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š

![co_yieldæµç¨‹å›¾](./sources/co_yield.png)

ä½¿ç”¨std::optionalæ¥å­˜å‚¨co_yieldçš„å€¼ä¾¿äºåç¨‹è°ƒç”¨æ–¹åˆ¤æ–­è¿­ä»£å¾ªç¯æ˜¯å¦ç»“æŸï¼Œå½“valueæ˜¯std::nulloptæ—¶ï¼Œåˆ™è¡¨æ˜åç¨‹co_yieldéƒ¨åˆ†ç»“æŸã€‚

æ³¨æ„ä¸ºäº†è®©è¿­ä»£å™¨è¿è¡Œæ­£å¸¸ï¼Œpromiseçš„initial_suspendå‡½æ•°è¿”å›äº†std::suspend_alawaysï¼Œè¯»è€…å¯ä»¥æ€è€ƒå¦‚æœè¿”å›std::suspend_neverä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜ã€‚

#### unhandled_exception

>```cpp
>// å‡½æ•°åŸå‹
>void promise::unhandled_exception();
>```

å¦‚æœåç¨‹åœ¨è¿è¡Œè¿‡ç¨‹ä¸­æŠ›å‡ºäº†å¼‚å¸¸ä¸”æ²¡æœ‰æ•è·ï¼Œé‚£ä¹ˆåç¨‹çš„è¿è¡Œä¼šæå‰ç»ˆæ­¢ï¼Œä¸”æ— æ³•é€šè¿‡coroutine_handleæ¢å¤åç¨‹ã€‚æ­¤æ—¶ç¼–è¯‘å™¨è°ƒç”¨promiseçš„unhandled_exceptionæ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ²¡æœ‰å‚æ•°ï¼Œæˆ‘ä»¬é€šå¸¸å®ç°è¯¥å‡½æ•°ä¸ºåˆ©ç”¨æ ‡å‡†åº“æä¾›çš„std::current_exceptionæ–¹æ³•è·å–å½“å‰å‘ç”Ÿçš„å¼‚å¸¸ï¼Œå¹¶å°†å¼‚å¸¸ä½œä¸ºå˜é‡å­˜å‚¨ï¼Œæ³¨æ„å¼‚å¸¸ä¸ä¼šå†å‘ä¸Šä¼ æ’­ã€‚æ­¤æ—¶æ§åˆ¶æƒè½¬ç§»åˆ°åç¨‹è°ƒç”¨è€…ï¼Œç”¨æˆ·å¯ä»¥åœ¨UserFacingçš„æ–¹æ³•ä¸­è·å–å­˜å‚¨çš„å¼‚å¸¸ï¼Œå¹¶å†æ¬¡æŠ›å‡ºå¼‚å¸¸ï¼Œå¦‚æ ·ä¾‹ç¨‹åºä¸­Taskçš„nextæ–¹æ³•æ‰€ç¤ºã€‚

>**ğŸ’¡ä¸ºä½•æ™®é€šå‡½æ•°åœ¨æŠ›å‡ºå¼‚å¸¸æœªæ•è·åå¼‚å¸¸ä¼šä¸€ç›´å‘ä¸Šä¼ é€’ç›´åˆ°è¢«æ•è·ï¼Œè€Œåç¨‹æŠ›å‡ºå¼‚å¸¸æœªæ•è·å´å¹¶ä¸ä¼šå‘ä¸Šä¼ é€’ï¼Ÿ**
>C++åç¨‹å…³äºå¼‚å¸¸å¤„ç†çš„æµç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼Œç¼–è¯‘å™¨ä¸ºæˆ‘ä»¬éšå¼çš„æ·»åŠ äº†try/catchè¯­å¥ï¼Œå› æ­¤å¼‚å¸¸å¹¶ä¸ä¼šä¼ æ’­åˆ°è°ƒç”¨è€…ã€‚ç»¼åˆæ¥çœ‹C++åç¨‹çš„è®¾è®¡è€…é€šè¿‡unhandled_exceptionä½¿å¾—åç¨‹çš„å¼‚å¸¸å¤„ç†æ›´åŠ çµæ´»ã€‚
>
>```cpp
>try{
>  // coroutine body
>} catch {
>  promise.unhandled_exception();
>}
>```

## Awaiter

å‰æ–‡æˆ‘ä»¬æåˆ°C++åç¨‹è®¾è®¡äº†å¤šç§ç±»å‹çš„è°ƒåº¦ç‚¹ï¼Œè€Œè¿™äº›è°ƒåº¦ç‚¹çš„å…·ä½“é€»è¾‘å‡åœ¨awaiterå†…å®ç°ï¼ŒC++åç¨‹æ ‡å‡†è¦æ±‚awaiterå¿…é¡»å®ç°ä¸‹åˆ—ä¸‰ä¸ªæ–¹æ³•ï¼š

- **await_ready**
- **await_suspend**
- **await_resume**

ç¼–è¯‘å™¨ä¼šæ ¹æ®ä¸Šè¿°å‰ä¸¤ç§æ–¹æ³•çš„è¿”å›å€¼æ¥é€‰æ‹©ä¸åŒçš„æ‰§è¡Œé€»è¾‘ï¼Œè€Œç¬¬ä¸‰ç§æ–¹æ³•åˆ™æ˜¯è·å–åç¨‹è¿”å›å€¼ã€‚ä¸promiseä¸åŒï¼Œawaiterå±äºæ¦‚å¿µè¾ƒä¸ºç®€å•ä½†å®æ“è¸©å‘å¾ˆå¤šï¼Œå› æ­¤æœ¬èŠ‚å°†ä¼šå…ˆè®²åŸºæœ¬æ¦‚å¿µæ ¹æ®å®æˆ˜ç¨‹åºç²¾è®²ã€‚

### co_await: awaiteræ‰§è¡Œçš„è§¦å‘å™¨

co_awaitå±äºC++åç¨‹ä¸‰å¤§å…³é”®å­—ä¹‹ä¸€ï¼Œæˆ‘ä»¬çŸ¥é“awaiterè´Ÿè´£å®ç°åç¨‹è°ƒåº¦é€»è¾‘ï¼Œä½†é€»è¾‘åªæ˜¯å®ç°äº†ï¼Œéœ€è¦co_await awaiteræ‰èƒ½æ‰§è¡Œæ­¤è°ƒåº¦é€»è¾‘ã€‚

ä»»ä½•awaiterçš„æ‰§è¡Œä¸€å®šé™„å¸¦co_awaitï¼Œç”¨æˆ·å¯ä»¥åœ¨åç¨‹ä½“å†…æ˜¾ç¤ºæ‰§è¡Œco_await awaiterè¯­å¥ï¼Œè€Œåƒä¸€äº›å†…ç½®æ–¹æ³•ï¼Œå¦‚promiseçš„initial_suspendå‡½æ•°è¿”å›çš„awaiterï¼Œä¼šç”±ç¼–è¯‘å™¨éšå¼ç”Ÿæˆco_await initial_suspendè¯­å¥ã€‚

é‚£co_awaitåé¢åªèƒ½è·Ÿawaiterå—ï¼Ÿç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œå¯ä»¥è¢«co_awaitçš„è¿˜æœ‰awaitableå¯¹è±¡â€”â€”å¯è¢«è½¬æ¢ä¸ºawaiterçš„å¯¹è±¡ã€‚æ¢å¥è¯è¯´ï¼Œco_awaitåŸæœ¬åªèƒ½å¯¹awaiterå¯¹è±¡æ“ä½œï¼Œä½†å¦‚æœä¸€ä¸ªå¯¹è±¡å¯ä»¥é€šè¿‡ç‰¹æ®Šçš„è½¬æ¢å˜ä¸ºawaiterï¼Œé‚£ä¹ˆè¯¥å¯¹è±¡ä¹Ÿå¯ä»¥è¢«co_awaitï¼Œæ­¤æ—¶co_awaiterä½œç”¨çš„æ˜¯è½¬æ¢åçš„awaiterï¼Œè¯¥å¯¹è±¡ä¹Ÿè¢«ç§°ä¸ºawaitableå¯¹è±¡ã€‚

C++æä¾›äº†ä¸¤ç§æ‰‹æ®µæ¥å®šä¹‰awaitableå¯¹è±¡ï¼š

- **awaiter operator co_await()**ã€‚co_awaitæœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªæ“ä½œç¬¦ï¼Œå½“å¯¹è±¡Aéawaiterä¸”å½“å‰å¯è§ä½œç”¨åŸŸå†…å­˜åœ¨å°†Aè½¬æ¢ä¸ºawaiterçš„co_awaitè¿ç®—ç¬¦é‡è½½å‡½æ•°æ—¶ï¼Œco_await Aä¼šè¢«è½¬æ¢ä¸ºco_await operator.co_await(A)ï¼Œé‡è½½å‡½æ•°å¯ä»¥æ˜¯ç±»æˆå‘˜å‡½æ•°ï¼Œä¹Ÿå¯ä»¥æ˜¯éæˆå‘˜å‡½æ•°ã€‚

>```cpp
>// æˆå‘˜å‡½æ•°
>class A{
>public:
>  auto operator co_await() -> awaiter;
>};
>
>// éæˆå‘˜å‡½æ•°
>class A;
>auto operator co_await(A) -> awaiter;
>```

- **awaiter promise::await_transform(T&)**ã€‚å¦‚æœæ˜¯åç¨‹ä½“å†…co_awaitå¯¹è±¡Aä¸”åç¨‹å…³è”çš„promiseç±»å­˜åœ¨await_transformå‡½æ•°ä¸”å…¥å‚ä¸ºAï¼Œé‚£ä¹ˆco_await Aå°†è¢«è½¬æ¢ä¸ºco_await promise.transform(A)ã€‚

å¦‚æœä¸Šè¿°ä¸¤ç§æ¡ä»¶å‡æ»¡è¶³ï¼Œé‚£ä¹ˆco_await Aå°†è¢«è½¬æ¢ä¸ºco_await operator co_await(promise.await_transform(A))ã€‚

### await_ready

>```cpp
>// å‡½æ•°åŸå‹
>bool awaiter::await_ready();
>```

ç”¨æˆ·ä»£ç æ‰§è¡Œco_await awaiteræ—¶ï¼Œç¼–è¯‘å™¨é¦–å…ˆæ‰§è¡Œawaiter.await_readyæ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å›boolç±»å‹ï¼Œå¦‚æœæ˜¯trueï¼Œå¦‚åŒå­—é¢æ„æ€readyä¸€æ ·ï¼Œä»£è¡¨å½“å‰åç¨‹å·²å°±ç»ªï¼Œå½“å‰åç¨‹é€‰æ‹©ç»§ç»­è¿è¡Œè€Œéæš‚åœï¼Œå¹¶ä¸”await_suspendæ–¹æ³•ä¸ä¼šè¢«è°ƒç”¨ã€‚

### await_suspend

>```cpp
>// å‡½æ•°åŸå‹1
>void awaiter::await_suspend(std::coroutine_handle<>);
>// å‡½æ•°åŸå‹2
>bool awaiter::await_suspend(std::coroutine_handle<>);
>// å‡½æ•°åŸå‹3
>std::coroutine_handle<> awaiter::await_suspend(std::coroutine_handle<>);
>```

å¦‚æœawait_readyæ–¹æ³•è¿”å›falseï¼Œæ­¤æ—¶ç¼–è¯‘å™¨ä¼šè°ƒç”¨awaiter.await_suspendæ–¹æ³•ã€‚

await_suspendå‚æ•°ä¸ºå½“å‰åç¨‹çš„coroutine_handleï¼Œè¿”å›å€¼æœ‰ä¸‰ç§å½¢å¼ï¼š

- **void**ã€‚å½“å‰åç¨‹æš‚åœï¼Œæ‰§è¡Œæƒè¿”å›ç»™å½“å‰åç¨‹çš„è°ƒç”¨è€…ã€‚
- **bool**ã€‚å¦‚æœå€¼ä¸ºtrueåˆ™åç¨‹æš‚åœï¼Œæ‰§è¡Œæƒè¿”å›ç»™å½“å‰åç¨‹çš„è°ƒç”¨è€…ï¼Œå¦åˆ™åç¨‹ç»§ç»­è¿è¡Œã€‚
- **coroutine_handle**ã€‚è¿”å›çš„åç¨‹å¥æŸ„ä¼šè¢«ç¼–è¯‘å™¨éšå¼è°ƒç”¨resumeå‡½æ•°ï¼Œå³è¯¥å¥æŸ„å…³è”çš„åç¨‹ä¼šç»§ç»­è¿è¡Œï¼Œä¹Ÿå¯ç›´æ¥è¿”å›å‚æ•°ä¸­çš„åç¨‹å¥æŸ„ï¼Œè¿™æ„å‘³ç€å½“å‰åç¨‹ä¼šç»§ç»­è¿è¡Œã€‚

æ³¨æ„è¿”å›å€¼ä¸ºcoroutine_handleæ—¶ï¼Œå¦‚æœæƒ³è½¬ç§»åç¨‹æ‰§è¡Œæƒï¼ŒC++å†…ç½®äº†std::noop_coroutineç±»ï¼Œè¿”å›è¯¥ç±»ä»£è¡¨ä½¿åç¨‹å¤„äºsuspendçŠ¶æ€ã€‚

### await_resume

>```cpp
>// å‡½æ•°åŸå‹
>T awaiter::await_resume();
>```

åœ¨è®²è§£promiseä¸€èŠ‚ä¸­æˆ‘ä»¬æåˆ°åç¨‹é€šè¿‡co_returnè¿”å›å€¼ï¼Œåç¨‹çš„è°ƒç”¨è€…é€šè¿‡UserFacingçš„æ–¹æ³•è·å–è¯¥è¿”å›å€¼ï¼Œä½†è·å–è¿”å›å€¼çš„è¿‡ç¨‹ä¸å¤Ÿä¼˜é›…ã€‚å¦‚æœåç¨‹è¿”å›çš„UserFacingå¯ä»¥è¢«è½¬æ¢ä¸ºawaiterä¸”è°ƒç”¨è€…ä¹Ÿæ˜¯åç¨‹çš„è¯å¯ä»¥æœ‰æ›´ç®€æ´çš„å†™æ³•ï¼š

```cpp
// å†™æ³•1
UserFacing obj = run();
T value = obj.get_return_value();

// å†™æ³•2
T value = co_await run();
```

å†™æ³•2æ›´åƒæ˜¯è°ƒç”¨æ™®é€šå‡½æ•°çš„å†™æ³•ï¼Œä¹‹æ‰€ä»¥èƒ½è·å–åˆ°è¯¥å€¼æ˜¯å› ä¸ºç¼–è¯‘å™¨ä¼šåœ¨å­åç¨‹ç¬¬ä¸€æ¬¡å¤„äºsuspendçŠ¶æ€æ—¶ï¼Œåœ¨è°ƒç”¨await_readyå’Œawait_suspendåè°ƒç”¨await_resumeæ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ— å‚æ•°ï¼Œä½†awaiteré€šå¸¸åœ¨è¢«æ„é€ æ—¶å¯é€‰æ‹©æŒæœ‰åç¨‹å¥æŸ„ï¼Œé€šè¿‡åç¨‹å¥æŸ„å°†å­åç¨‹co_returnçš„å€¼è¿”å›ï¼Œå…·ä½“è¿‡ç¨‹ä¸promiseæ ·ä¾‹ç¨‹åºä¸­UserFacingè·å–åç¨‹è¿”å›å€¼ç±»ä¼¼ã€‚

éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯å¦‚æœå­åç¨‹è½¬æ¢åçš„awaiterä½¿å¾—çˆ¶åç¨‹å¤„äºsuspendçŠ¶æ€ï¼Œé‚£ä¹ˆçˆ¶åç¨‹æ¢å¤åä¼šç«‹åˆ»æ‰§è¡Œawait_resumeã€‚

>ğŸ’¡**å½“co_awaitå­åç¨‹æ—¶ï¼Œå­åç¨‹åœ¨ä¸­é€”è¢«suspendæ¥ä¸åŠè¿”å›å€¼ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨è¿˜ä¼šè°ƒç”¨await_resumeå—ï¼Ÿ**
>ä¼šçš„ï¼Œæ­¤æ—¶ç”¨æˆ·éœ€è¦è‡ªè¡Œè§£å†³è¿™ç§é—®é¢˜ï¼Œæ¯”å¦‚ä½¿ç”¨optionalå­˜å‚¨è¿”å›å€¼æ¥æ–¹ä¾¿åˆ¤æ–­è°ƒç”¨è€…æ‹¿åˆ°çš„è¿”å›å€¼æ˜¯å¦æœ‰æ•ˆã€‚

### awaiterçš„ç”Ÿå‘½å‘¨æœŸ

å¦‚æœåœ¨æ‰§è¡Œäº†co_awaitæ“ä½œåäº§ç”Ÿäº†ä¸´æ—¶çš„awaiterå¯¹è±¡ï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œå®Œawait_resumeåç¼–è¯‘å™¨ä¼šç«‹åˆ»æ‰§è¡Œawaiterçš„ææ„ï¼Œå¯¹äºéä¸´æ—¶awaiterå°±æ˜¯éšç€ä½œç”¨åŸŸç»“æŸææ„ã€‚

### åç¨‹é—´çš„çŠ¶æ€è½¬ç§»

è¯»è€…åº”è¯¥å·²çŸ¥æ™“await_suspendå‡½æ•°å¯ä»¥æ§åˆ¶åç¨‹æ‰§è¡Œæƒçš„è½¬ç§»ï¼Œä½†å…³äºæ‰§è¡Œæƒè½¬ç§»çš„ç»†èŠ‚è¿˜æ˜¯è¦é‡ç‚¹å¼ºè°ƒä¸€ä¸‹ã€‚

C++å¯¹åç¨‹çš„è®¾è®¡æ˜¯åŸºäºçŠ¶æ€æœºçš„ï¼Œæˆ‘ä»¬å…ˆåˆ†æä¸€ä¸‹å„ç§caseä¸‹åç¨‹çŠ¶æ€çš„å˜åŒ–ï¼š

- **await_suspendè¿”å›voidï¼š** æ­¤æ—¶åç¨‹é™·å…¥suspendçŠ¶æ€ã€‚
- **await_suspendè¿”å›boolï¼š** å¦‚æœä¸ºtrueåˆ™åç¨‹é™·å…¥suspendçŠ¶æ€ï¼Œå¦åˆ™æ¢å¤è¿è¡Œã€‚
- **await_suspendè¿”å›åç¨‹å¥æŸ„ï¼š** å¦‚æœè¿”å›è‡ªèº«å¥æŸ„ï¼Œåˆ™æ¢å¤è¿è¡Œï¼Œå¦‚æœè¿”å›å…¶ä»–å¥æŸ„ï¼Œé‚£ä¹ˆå½“å‰åç¨‹é™·å…¥suspendçŠ¶æ€ï¼Œæ‰§è¡Œæƒè½¬ç§»è‡³è¿”å›å¥æŸ„å¯¹åº”çš„åç¨‹ï¼Œå³ä½¿è¿”å›noop_coroutineå½“å‰åç¨‹ä¹Ÿä¼šé™·å…¥suspendçŠ¶æ€ã€‚

å¯¹äºä¸Šè¿°ä½¿å¾—åç¨‹é™·å…¥suspendçŠ¶æ€ä½†æ²¡æœ‰æ˜ç¡®åç»­è°ƒç”¨åç¨‹çš„æƒ…å†µè¯»è€…èƒ½æ¸…æ¥šçš„è¯´å‡ºæ¥ä¸‹æ¥æ‰§è¡Œæƒè¯¥å¦‚ä½•è½¬ç§»å—ï¼Ÿæ¯”å¦‚await_suspendè¿”å›voidï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥ç¨‹åºæ€ä¹ˆæ‰§è¡Œï¼Ÿåƒæ™®é€šå‡½æ•°è°ƒç”¨ä¸€æ ·å›åˆ°è°ƒç”¨è€…å—ï¼Ÿç­”æ¡ˆå¹¶ä¸æ˜¯ã€‚

å…¶å®ç­”æ¡ˆå¾ˆç®€å•ï¼Œå¦‚æœåç¨‹é™·å…¥suspendçŠ¶æ€é‚£ä¹ˆåç¨‹å†…éƒ¨ä¿¡æ¯ä¼šè®°å½•è¯¥çŠ¶æ€ï¼Œç„¶åæ ¹æ®åç¨‹åµŒå¥—è°ƒç”¨äº§ç”Ÿçš„æ ˆé€å±‚å‘ä¸Šç›´åˆ°é‡åˆ°æ™®é€šå‡½æ•°æˆ–è€…ésuspendçŠ¶æ€çš„åç¨‹ï¼Œæ‰€ä»¥å¦‚æœçˆ¶çº§è°ƒç”¨è€…æ˜¯åç¨‹ä½†ä¹Ÿå¤„äºsuspendçŠ¶æ€é‚£ä¹ˆçˆ¶åç¨‹æ˜¯ä¸ä¼šæ¢å¤æ‰§è¡Œçš„ã€‚

> **âš ï¸åç¨‹æ‰§è¡ŒçŠ¶æ€çš„å˜æ›´åªæœ‰é€šè¿‡é™·å…¥suspendå’Œresumeæ‰ä¼šå˜æ›´ï¼Œåœ¨æ‰§è¡Œè¡Œè¿‡ç¨‹ä¸­åªè¦æœªå‡ºç°åç¨‹è°ƒåº¦ç‚¹é‚£ä¹ˆä»»ä½•åç¨‹çŠ¶æ€éƒ½ä¸ä¼šå˜åŒ–**

### awaiterå®æˆ˜æ¡ˆä¾‹ç²¾è®²

å…³äºawaiterçš„åŸºç¡€æ¦‚å¿µéƒ¨åˆ†ï¼Œè¯»è€…å¯å‚è€ƒç¨‹åº[co_demo.awaiters.cpp](https://www.chiark.greenend.org.uk/~sgtatham/quasiblog/coroutines-c++20/co_demo.awaiters.cpp)åŠ æ·±ç†è§£ã€‚

è€Œæ ‡å‡†åº“é¢„ç½®çš„std::suspend_alwayså’Œstd::suspend_neverè¯»è€…åº”è¯¥ä¹Ÿèƒ½æ˜ç™½å…¶å®ç°åŸç†ã€‚

```cpp
struct suspend_always
{
  constexpr bool await_ready() const noexcept { return false; }
  constexpr void await_suspend(coroutine_handle<>) const noexcept {}
  constexpr void await_resume() const noexcept {}
};
struct suspend_never
{
  constexpr bool await_ready() const noexcept { return true; }
  constexpr void await_suspend(coroutine_handle<>) const noexcept {}
  constexpr void await_resume() const noexcept {}
};
```

æœ¬èŠ‚æ¡ˆä¾‹ç²¾è®²æˆ‘ä¸ºè¯»è€…ç¼–å†™äº†ä¸€ä¸ªç‰¹åˆ«çš„åç¨‹ç¨‹åºï¼Œè¯¥ç¨‹åºé‡ç‚¹å…³æ³¨awaiterçŸ¥è¯†ç‚¹ï¼Œç®€åŒ–äº†æ— å…³çš„promiseï¼Œå¹¶ä¸”æ·»åŠ äº†å¤šå¤„æ—¥å¿—ä¾¿äºåˆ†æï¼Œä»£ç å¦‚ä¸‹ï¼š

```cpp
#include <coroutine>
#include <iostream>

std::coroutine_handle<> global_handle;

class Event
{
public:
  Event() { std::cout << "event construct" << std::endl; }
  ~Event() { std::cout << "event deconstruct" << std::endl; }

  bool await_ready() { return false; }
  std::coroutine_handle<> await_suspend(std::coroutine_handle<> caller) { return caller; }
  void await_resume()
  {
    std::cout << "await resume called" << std::endl;
  }
};

class Task
{
public:
  class promise_type;
  using handle_type = std::coroutine_handle<promise_type>;
  class promise_type
  {
    friend class Task;

  public:
    promise_type(int id) : m_id(id) {}
    Task get_return_object()
    {
      auto handle = handle_type::from_promise(*this);
      global_handle = handle;
      return Task(handle, m_id);
    }

    constexpr std::suspend_never initial_suspend() { return {}; }

    void return_void() {}

    void unhandled_exception() {}

    constexpr std::suspend_always final_suspend() noexcept { return {}; }

  private:
    int m_id;
  };

public:
  Task(const Task &) = delete;
  Task(Task &&other) : m_handle(other.m_handle)
  {
    other.m_handle = nullptr;
  }
  Task &operator=(const Task &other) = delete;
  Task &operator=(Task &&other)
  {
    if (m_handle)
    {
      m_handle.destroy();
    }
    m_handle = other.m_handle;
    other.m_handle = nullptr;
    return *this;
  }

  ~Task()
  {
    std::cout << "deconstruct task " << m_id << std::endl;
  }

public:
  auto operator co_await()
  {
    return Event{};
  }

  void resume()
  {
    m_handle.resume();
  }

private:
  Task(handle_type handle, int id) : m_handle(handle), m_id{id}
  {
    std::cout << "construct task " << m_id << std::endl;
  }

private:
  int m_id;
  handle_type m_handle;
};

Task run(int i)
{
  std::cout << "task " << i << " start" << std::endl;
  if (i == 0)
  {
    co_await run(i + 1);
  }
  else
  {
    std::cout << "task " << i << " will suspend" << std::endl;
    co_await std::suspend_always{};
  }

  std::cout << "task " << i << " will suspend" << std::endl;
  co_await std::suspend_always{};

  std::cout << "task " << i << " end" << std::endl;
  co_return;
}

int main(int argc, char const *argv[])
{
  /* code */
  auto task = run(0);
  std::cout << "back to main" << std::endl;
  global_handle.resume();
  std::cout << "run finish" << std::endl;
  return 0;
}
```

è¯¥ç¨‹åºå®ç°äº†ä¸‹å›¾çš„è¿è¡Œæ•ˆæœï¼Œè¯»è€…ä»è¿è¡Œå›¾å¯ä»¥æ›´ç›´è§‚åœ°æ„Ÿå—åç¨‹ä¸æ™®é€šå‡½æ•°çš„ä¸åŒã€‚

![corocallstack](./sources/corocallstack.png)

è¯»è€…å¯ä»¥è§‚å¯Ÿç¨‹åºå¾—å‡ºä¸€ä¸ªè¾“å‡ºç»“æœï¼Œç„¶åä¸ä¸‹åˆ—çœŸå®è¾“å‡ºç»“æœç›¸å¯¹ç…§ï¼š

```txt
construct task 0
task 0 start
construct task 1
task 1 start
task 1 will suspend
event construct
await resume called
event deconstruct
deconstruct task 1
task 0 will suspend again
back to main
task 1 will suspend again
run finish
deconstruct task 0
```

å…³äºä¸Šè¿°ç¨‹åºæ¶‰åŠåˆ°çš„çŸ¥è¯†ç‚¹æˆ‘ä»¬ä¸€ä¸€è®²è§£ï¼š

1. **UserFacingçš„æ„é€ æ—¶æœº**ï¼šåœ¨è°ƒç”¨åç¨‹æ—¶UserFacingå¯¹è±¡é€šè¿‡promise.get_return_objectå‡½æ•°è¢«æ„é€ ï¼Œå…ˆäºåç¨‹è¿è¡Œã€‚
2. **awaiteré€»è¾‘çš„æ‰§è¡Œæ—¶æœº**ï¼šå¦‚æœco_awaitæ“ä½œçš„æ˜¯ä¸€ä¸ªå­åç¨‹ï¼ˆawaitableå¯¹è±¡ï¼‰ï¼Œè€Œéç›´æ¥çš„awaiterï¼Œé‚£ä¹ˆä¼šå…ˆæ‰§è¡Œå­åç¨‹çš„è°ƒç”¨é€»è¾‘ï¼Œå½“å­åç¨‹ç¬¬ä¸€æ¬¡suspendæ—¶ï¼Œawaiteræ‰ä¼šè¢«æ„é€ ï¼ˆä½¿ç”¨åˆ†é…å¥½çš„åç¨‹å¸§å†…å­˜ï¼‰ï¼Œç„¶åè°ƒç”¨await_readyï¼Œawait_suspendï¼ˆé€‰æ‹©æ€§åœ°ï¼‰å’Œawait_resumeï¼Œéšåawaiterææ„ï¼Œç”±è¯¥co_awaitäº§ç”Ÿçš„è°ƒåº¦ç‚¹ç»“æŸã€‚
3. **UserFacingçš„ææ„æ—¶æœº**ï¼šè¯»è€…å¯ä»¥æ³¨æ„åˆ°â€œdeconstruct task 1â€åœ¨â€œevent deconstructâ€ä¹‹åè¾“å‡ºï¼Œå› ä¸ºæ‰§è¡Œco_await run(1)å¹¶æœªç›´æ¥è·å–å…¶UserFacingå¯¹è±¡ï¼Œåªæ˜¯ç¼–è¯‘å™¨éœ€è¦å…¶è½¬æ¢åçš„awaiterï¼Œawaiterç”Ÿå‘½å‘¨æœŸç»“æŸåUserFaingå¯¹è±¡ä¹Ÿä¼šè¢«ç¼–è¯‘å™¨æ‰§è¡Œææ„æ“ä½œï¼Œä½†æ­¤æ—¶run(1)åç¨‹æ‰§è¡Œå¹¶æœªç»“æŸï¼Œæ‰€ä»¥æ ·ä¾‹ç§»é™¤äº†UserFacingææ„å‡½æ•°é‡Œhandle.destroyæ“ä½œï¼Œè¿™æ ·ä¼šé€ æˆå†…å­˜æ³„æ¼ï¼ˆè¯¥æ ·ä¾‹ä¸­çš„å†…å­˜æ³„æ¼è¯»è€…å¯å¿½ç•¥ï¼‰ï¼Œæ‰€ä»¥æœ‰ä¸€ç§åšæ³•ä¿ç•™ææ„å‡½æ•°çš„destroyæ“ä½œï¼Œå°†UserFacingç§»åŠ¨åˆ°awaiteré‡Œã€‚
4. **åç¨‹suspendæ—¶æ‰§è¡Œæƒçš„è½¬ç§»**ï¼šrun(1)åç¨‹ä¸€å…±å‘ç”Ÿäº†ä¸¤æ¬¡suspendï¼Œç¬¬ä¸€æ¬¡suspendåæ‰§è¡Œæƒè¿”å›ç»™äº†run(0)åç¨‹ï¼Œç¬¬äºŒæ¬¡æ˜¯è¿”å›ç»™äº†mainå‡½æ•°ï¼Œéƒ¨åˆ†è¯»è€…å¯èƒ½ä¼šè§‰å¾—æ˜¯run(0)åç¨‹è°ƒç”¨äº†run(1)åç¨‹ï¼Œæ‰€ä»¥run(1) suspendåº”è¯¥æ€»æ˜¯å›åˆ°run(0)ï¼Œè¿™ç§ç†è§£æ˜¯é”™è¯¯çš„ï¼Œå®é™…ä¸Šæ‰§è¡Œæƒæ˜¯å›åˆ°æœ€è¿‘è°ƒç”¨/æ¢å¤åç¨‹çš„ä¸€æ–¹ã€‚

æœ€åï¼Œå…³äºåç¨‹åµŒå¥—è°ƒç”¨çš„å¤„ç†å®é™…ä¸Šååˆ†å¤æ‚ï¼Œæƒ³è¦å†™å‡ºæ™®é€šå‡½æ•°é‚£æ ·é€’å½’è°ƒç”¨çš„é€»è¾‘æ˜¯éœ€è¦ç”¨æˆ·åšå¾ˆå¤šé¢å¤–å·¥ä½œçš„ï¼Œæœ¬èŠ‚çš„ç¤ºä¾‹ä»…ä»…æ˜¯å±•ç¤ºäº†å†°å±±ä¸€è§’ï¼Œåç»­ä¼šç»™å‡ºæ›´å¤æ‚çš„ç¤ºä¾‹å’Œè®²è§£ã€‚

>**ğŸ’¡æ€è€ƒé¢˜**ï¼šå¦‚æœå°†Eventçš„await_suspendæ–¹æ³•è¿”å›å€¼æ”¹æˆglobal_handleï¼Œé‚£ä¹ˆç¤ºä¾‹çš„è¿è¡Œæ—¶å›¾éœ€è¦æ€æ ·ä¿®æ”¹ï¼Ÿ

## åç¨‹å®ä¾‹è®²è§£

### çº¿ç¨‹é—´è°ƒåº¦åç¨‹

è¿™ä¸ªä¾‹å­æ¥è‡ªäºcppreferenceå®˜ç½‘ç»™å‡ºçš„æ ·ä¾‹ï¼Œç›®çš„æ˜¯æ¼”ç¤ºåç¨‹å¦‚ä½•è·¨çº¿ç¨‹æ‰§è¡Œï¼Œä»£ç å¦‚ä¸‹ï¼š

```cpp
#include <coroutine>
#include <iostream>
#include <stdexcept>
#include <thread>

auto switch_to_new_thread(std::jthread &out)
{
  struct awaitable
  {
    std::jthread *p_out;
    bool await_ready() { return false; }
    void await_suspend(std::coroutine_handle<> h)
    {
      std::jthread &out = *p_out;
      if (out.joinable())
        throw std::runtime_error("jthread è¾“å‡ºå‚æ•°éç©º");
      out = std::jthread([h]
                         { h.resume(); });
      // æ½œåœ¨çš„æœªå®šä¹‰è¡Œä¸ºï¼šè®¿é—®æ½œåœ¨è¢«é”€æ¯çš„ *this
      // std::cout << "æ–°çº¿ç¨‹ IDï¼š" << p_out->get_id() << '\n';
      std::cout << "æ–°çº¿ç¨‹ IDï¼š" << out.get_id() << '\n'; // è¿™æ ·æ²¡é—®é¢˜
    }
    void await_resume() {}
  };
  return awaitable{&out};
}

struct task
{
  struct promise_type
  {
    task get_return_object() { return {}; }
    std::suspend_never initial_suspend() { return {}; }
    std::suspend_never final_suspend() noexcept { return {}; }
    void return_void() {}
    void unhandled_exception() {}
  };
};

task resuming_on_new_thread(std::jthread &out)
{
  std::cout << "åç¨‹å¼€å§‹ï¼Œçº¿ç¨‹ IDï¼š" << std::this_thread::get_id() << '\n';
  co_await switch_to_new_thread(out);
  // ç­‰å¾…å™¨åœ¨æ­¤é”€æ¯
  std::cout << "åç¨‹æ¢å¤ï¼Œçº¿ç¨‹ IDï¼š" << std::this_thread::get_id() << '\n';
}

int main()
{
  std::jthread out;
  resuming_on_new_thread(out);
}
```

è¿è¡Œç»“æœå¦‚ä¸‹ï¼š

```txt
åç¨‹å¼€å§‹ï¼Œçº¿ç¨‹ IDï¼š1
æ–°çº¿ç¨‹ IDï¼š2
åç¨‹æ¢å¤ï¼Œçº¿ç¨‹ IDï¼š2
```

è¯¥ç¨‹åºåœ¨await_suspendä¸­ä½¿ç”¨äº†jthreadæ¥æ¢å¤åç¨‹ï¼Œjthreadåœ¨ææ„æ—¶ä¼šè‡ªåŠ¨joinï¼Œæ‰€ä»¥ç¨‹åºä¸€å®šå¯ä»¥ç­‰åˆ°åç¨‹æ‰§è¡Œå®Œæ¯•å†ç»“æŸã€‚åœ¨å®é™…åº”ç”¨ä¸­å¯ä»¥é€‰æ‹©æ„é€ ä¸€ä¸ªçº¿ç¨‹æ± é€šè¿‡æ·»åŠ æœªæ‰§è¡Œå®Œæ¯•åç¨‹çš„å¥æŸ„ï¼Œå¹¶åœ¨è·å–å¥æŸ„çš„çº¿ç¨‹ä¸­æ¢å¤åç¨‹è¿è¡Œã€‚

### åç¨‹çš„æ ˆå¼è°ƒç”¨

å‰æ–‡æåˆ°è¿‡å¦‚æœæƒ³è®©åç¨‹åƒæ™®é€šå‡½æ•°ä¸€æ ·æ‹¥æœ‰æ­£ç¡®çš„åµŒå¥—è°ƒç”¨æ‰§è¡Œé¡ºåºæ˜¯æœ‰ä¸€å®šéš¾åº¦çš„ã€‚**é‚£ä»€ä¹ˆå«åšæ­£ç¡®çš„åµŒå¥—æ‰§è¡Œè°ƒç”¨é¡ºåº**ï¼Ÿ

ä¸‹å›¾ç»™å‡ºäº†æ™®é€šå‡½æ•°ä¸åç¨‹çš„å¯¹æ¯”ï¼š

![coro_stack](./sources/coro_stack.png)

è¯»è€…ä¸éš¾çœ‹å‡ºåç¨‹å¯ä»¥åœ¨å­åç¨‹æš‚åœåç»§ç»­æ‰§è¡Œçˆ¶åç¨‹ï¼Œå½“ç„¶è¿™ä¸ªæ‰§è¡Œé€»è¾‘æ˜¯ç”±ç”¨æˆ·è‡ªå®šä¹‰çš„ï¼Œé—®é¢˜åœ¨äºè¿™ç§æ‰§è¡Œé€»è¾‘ä¸‹ï¼Œåç¨‹Aåœ¨å­åç¨‹Båªæ‰§è¡Œä¸€éƒ¨åˆ†åç»§ç»­æ‰§è¡Œï¼Œä¸æˆ‘ä»¬çš„ç›®æ ‡â€”â€”æ¨¡æ‹Ÿæ™®é€šå‡½æ•°è°ƒç”¨ä¸ç¬¦ï¼Œæˆ‘ä»¬æœŸæœ›çš„æ˜¯å“ªæ€•åç¨‹åµŒå¥—è°ƒç”¨äº†100å±‚ï¼Œå¦‚æœæœ€åº•å±‚åç¨‹å¤„äºsuspendçŠ¶æ€ï¼Œé‚£ä¹ˆä¸Šå±‚çš„æ‰€æœ‰åç¨‹å‡ä¸å¯ä»¥ç»§ç»­æ‰§è¡Œï¼Œè‹¥è¦ç»§ç»­æ‰§è¡Œåªèƒ½é€‰æ‹©æ¢å¤æ‰§è¡Œæœ€åº•å±‚çš„åç¨‹ï¼Œè¦å®ç°è¿™äº›éœ€è¦æˆ‘ä»¬åœ¨ä»£ç ä¸­è®°å½•åç¨‹è°ƒç”¨æ ˆä¿¡æ¯ã€‚

æœ¬èŠ‚ä»£ç [co_stack.cpp](https://www.chiark.greenend.org.uk/~sgtatham/quasiblog/coroutines-c++20/co_stack.cpp)æ‘˜è‡ªåšå®¢[Writing custom C++20 coroutine systems](https://www.chiark.greenend.org.uk/~sgtatham/quasiblog/coroutines-c++20/#stacked-generators)ï¼Œä»£ç è¾ƒé•¿è¯»è€…å¯å»ç½‘é¡µç«¯æŸ¥çœ‹ã€‚

ä»£ç çš„å…¶ä»–å®ç°ç»†èŠ‚ä¸å†ç»†è®²ï¼Œæœ¬æ–‡ä¸»è¦å…³æ³¨å…¶æ ¸å¿ƒå®ç°æ¨¡æ‹Ÿæ ˆå¼è°ƒç”¨çš„éƒ¨åˆ†ï¼Œç¤ºæ„å›¾å¦‚ä¸‹ï¼š

![coro_stack_structure](./sources/coro_stack_structure.png)

åœ¨promiseæ·»åŠ äº†3ä¸ªæŒ‡é’ˆï¼š

- outerï¼šæŒ‡å‘æœ€ä¸Šå±‚åç¨‹å…³è”çš„promiseã€‚
- parentï¼šæŒ‡å‘å½“å‰åç¨‹çš„çˆ¶åç¨‹å…³è”çš„promiseï¼Œå¦‚æœæ²¡æœ‰çˆ¶åç¨‹åˆ™ä¸ºnullptrã€‚
- currentï¼šæŒ‡å‘æœ€åº•å±‚ä¹Ÿå°±æ˜¯æ­£åœ¨è¿è¡Œçš„åç¨‹å…³è”çš„promiseã€‚

é€šè¿‡åœ¨promiseä¸­æ·»åŠ ä¸Šè¿°ä¸‰ç§æŒ‡é’ˆï¼Œå½“åç¨‹A co_await åç¨‹Bæ—¶ï¼Œç”±äºåç¨‹Båœ¨initial_suspendå‡½æ•°ä¸­è¿”å›äº†suspend_alwaysï¼Œæ‰€ä»¥åç¨‹Bå¤„äºsuspendçŠ¶æ€ï¼Œæ­¤æ—¶æ„é€ awaiterï¼Œåœ¨awaiterçš„await_suspendå‡½æ•°ä¸­å®Œæˆpromiseä¸‰ä¸ªæŒ‡é’ˆçš„èµ‹å€¼ï¼Œç„¶åè¿”å›åç¨‹Bçš„å¥æŸ„ï¼Œåç¨‹Bç»§ç»­æ‰§è¡Œã€‚

å¦‚æœåç¨‹Båœ¨è¿”å›å‰å†æ¬¡é™·å…¥suspendçŠ¶æ€ï¼Œæ¯”å¦‚è°ƒç”¨co_yieldï¼Œæ­¤æ—¶ä¼šåœ¨yield_valueå‡½æ•°ä¸­è®¾ç½®outerçš„yieldçš„å€¼ï¼Œå¹¶è¿”å›suspend_alwaysï¼Œæ­¤æ—¶æ‰§è¡Œæƒä¼šæ³¨æ„åˆ°outerçš„ä¸Šå±‚ï¼ˆè¯·è¯»è€…æ€è€ƒä¸ºä»€ä¹ˆï¼‰ï¼Œå³ä¸€ä¸ªæ™®é€šå‡½æ•°ï¼Œæ­¤æ—¶æ™®é€šå‡½æ•°æŒæœ‰outerå…³è”çš„UserFacingå¯¹è±¡ï¼Œé€šè¿‡è¯¥å¯¹è±¡è·å–yieldçš„å€¼ï¼Œæ‰€ä»¥æ ·ä¾‹ç¨‹åºä¸­åµŒå¥—è°ƒç”¨çš„åç¨‹yieldçš„å€¼å‡æ˜¯ä¼ é€’åˆ°ä¸Šå±‚å¤„ç†çš„ã€‚

outerçš„è°ƒç”¨è€…åœ¨è·å–yieldçš„å€¼åä¼šè°ƒç”¨outerå…³è”çš„UserFacingå¯¹è±¡çš„nextæ–¹æ³•ï¼Œè¿™æ—¶å€™promiseæŒæœ‰çš„currentæŒ‡é’ˆå‘æŒ¥ä½œç”¨äº†ï¼Œnextæ–¹æ³•è°ƒç”¨äº†handle.resumeï¼Œåªæ˜¯è¯¥handleä¸æ˜¯outerçš„handleï¼Œè€Œæ˜¯currentçš„handleã€‚

åç¨‹Bæ‰§è¡Œå®Œæ¯•åç¼–è¯‘å™¨è°ƒç”¨final_suspendå‡½æ•°ï¼Œè¯¥å‡½æ•°å…ˆä¿®æ”¹äº†promiseçš„currentæŒ‡é’ˆï¼ˆå› ä¸ºcurrentæ‰§è¡Œç»“æŸäº†ï¼‰ï¼Œç„¶åè¿”å›äº†ä¸€ä¸ªç‰¹æ®Šçš„awaiterï¼Œåœ¨awaiteråœ¨await_suspendå‡½æ•°ä¸­è¿”å›äº†parentå…³è”çš„åç¨‹å¥æŸ„ï¼Œå³æ¢å¤åç¨‹Açš„è¿è¡Œï¼Œå¦‚æœè¯¥awaiterçš„await_suspendå‡½æ•°è¿”å›suspend_alwaysï¼Œé‚£ä¹ˆæ‰§è¡Œæƒä¼šè¿”å›è‡³outerçš„ä¸Šå±‚è°ƒç”¨è€…ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆpromiseéœ€è¦parentæˆå‘˜å˜é‡ï¼Œå¯ä»¥è®©åç¨‹è°ƒç”¨æ ˆä¿æŒæ­£ç¡®çš„æ‰§è¡Œé¡ºåºã€‚

<!-- TODO -->
<!-- >**ğŸ’¡ä¸ºä½•æ ·ä¾‹ä¸­awaiterè¿”å›std::suspend_alwaysåæ‰§è¡Œæƒä¼šç›´æ¥è½¬ç§»åˆ°outerçš„è°ƒç”¨è€…è€Œä¸æ˜¯parentï¼Ÿ** -->

## åç¨‹å®è·µæ€»ç»“

ä»ç¼–è¯‘å™¨è§†è§’çœ‹ï¼Œåç¨‹æ‰§è¡Œçš„ä¼ªä»£ç ä¸ºå¦‚ä¸‹ï¼Œæ­¤æ—¶è¯»è€…åº”è¯¥èƒ½ç†è§£promiseå„ä¸ªæˆå‘˜å‡½æ•°çš„ä½œç”¨ã€‚

```cpp
{
  co_await promise.initial_suspend();
  try
  {
    <body-statements>
  }
  catch (...)
  {
    promise.unhandled_exception();
  }
FinalSuspend:
  co_await promise.final_suspend();
}
```

å†æ¥å›é¡¾ç¬¬äºŒç« æåˆ°çš„åç¨‹çŠ¶æ€åˆ‡æ¢å›¾ï¼Œè¿™å…¶ä¸­çš„å„ä¸ªçŠ¶æ€è½¬ç§»è¯»è€…åº”èƒ½äº†å¦‚æŒ‡æŒã€‚

![åç¨‹çŠ¶æ€åˆ‡æ¢](./sources/coro_state.png)

## å‚è€ƒæ–‡çŒ®

åœ¨æ’°å†™æœ¬æ–‡å‰ä½œè€…æœ¬äººç«‹ä¸‹äº†ä¸€ä¸ªç›®æ ‡ï¼Œé‚£å°±æ˜¯æœ¬æ–‡è¦å°½åŠ›ç…§é¡¾åˆå­¦è€…ï¼Œä»…æ­¤ä¸€æ–‡ä¾¿ä½¿è¯»è€…å½»åº•å…¥é—¨C++åç¨‹ã€‚å¯æƒœçš„æ˜¯åœ¨ä¸æ–­åœ°æŸ¥èµ„æ–™åå‘ç°è‹¥è¦æ·±ç©¶C++åç¨‹ï¼Œå†™ä¸ª10ç¯‡éƒ½è®²ä¸å®Œï¼Œå› æ­¤åœ¨å­¦ç½¢æœ¬æ–‡åï¼Œæˆ‘åˆ—å‡ºä¸‹åˆ—å‚è€ƒæ–‡çŒ®ä¾›è¯»è€…å­¦ä¹ ã€‚

### ä¼˜å…ˆæ¨èç³»åˆ—

- [Coroutine Theory](https://lewissbaker.github.io/)ï¼šå¤§ä½¬ç”¨5ç¯‡åšå®¢è¯¦ç»†è®²è§£äº†C++åç¨‹çš„å…¥é—¨æ¦‚å¿µä»¥åŠåº•å±‚åŸç†ï¼Œå¯¹åº•å±‚å®ç°æ„Ÿå…´è¶£çš„å¿…çœ‹ï¼Œ
- [Writing custom C++20 coroutine systems](https://www.chiark.greenend.org.uk/~sgtatham/quasiblog/coroutines-c++20/)ï¼šä½œè€…ä»å®è·µçš„è§’åº¦ç»†è‡´è®²è§£äº†C++åç¨‹çš„å„ä¸ªæ¦‚å¿µï¼Œå°¤å…¶æ˜¯ç»™å‡ºäº†å¾ˆå¤šé«˜è´¨é‡çš„æ ·ä¾‹ç¨‹åºã€‚
- [åç¨‹ (C++20)](https://cppreference.cn/w/cpp/language/coroutines)ï¼šcppreferenceä¸­å¯¹C++åç¨‹åšå‡ºäº†æ¯”è¾ƒå®˜æ–¹çš„è®²è§£ï¼Œç¯‡å¹…ååˆ†ç²¾ç®€ã€‚

### é€‰çœ‹ç³»åˆ—

- [My tutorial and take on C++20 coroutines](https://www.scs.stanford.edu/~dm/blog/c++-coroutines.html#compiling-code-using-coroutines)
- [Understanding C++ Coroutine Implementation](https://medium.com/@AlexanderObregon/understanding-c-coroutine-implementation-8e6e5a2c3edd)
- [luncliff/coroutine](https://luncliff.github.io/coroutine/)
- [æ ‡å‡†åº“å¤´æ–‡ä»¶coroutine](https://cppreference.cn/w/cpp/header/coroutine)
- [æœ‰æ ˆåç¨‹å’Œæ— æ ˆåç¨‹](https://cloud.tencent.com/developer/article/1888257)
- [è¯¦ç»†äº†è§£åç¨‹](https://zhuanlan.zhihu.com/p/535658398)
- [Linuxé«˜æ€§èƒ½ç½‘ç»œç¼–ç¨‹åè°ˆ|åç¨‹](https://zhuanlan.zhihu.com/p/648556418)
- [linux ucontextæ—å‡½æ•°çš„åŸç†åŠä½¿ç”¨](https://blog.csdn.net/chenzhjlf/article/details/124606523)
- [å…³äºåç¨‹ï¼Œä½ äº†è§£å¤šå°‘ï¼Ÿ](https://www.kepuchina.cn/article/articleinfo?business_type=100&ar_id=478676)
- [C++åç¨‹ï¼ˆCoroutinesï¼‰](https://ovea-y.cn/cpp_coroutine_20/)
- [ç‚¹è¯„äº‘é£çš„Cåº“coroutine](https://microcai.org/2024/12/16/dig-into-coroutine-lib.html)
- [C++20åç¨‹åŸç†å’Œåº”ç”¨](https://zhuanlan.zhihu.com/p/497224333)
- [æœ‰æ ˆåç¨‹ä¸æ— æ ˆåç¨‹](https://zhuanlan.zhihu.com/p/330606651)

## å®éªŒæ€»ç»“

æœ¬æ–‡ä»å®è·µçš„è§’åº¦å¯¹C++åç¨‹ä¸¤å¤§åŸºç¡€æ¦‚å¿µâ€”â€”promiseå’Œawaiteråšäº†ç»†è‡´çš„è®²è§£ï¼Œå¹¶ç»™å‡ºäº†æ ·ä¾‹ç¨‹åºè®²è§£ï¼Œæœ¬è¯¾ç¨‹å…³äºC++åç¨‹çš„å­¦ä¹ åˆ°æ­¤ç»“æŸï¼Œåç»­å°†ä¼šè®²è§£æœ¬è¯¾ç¨‹ç¬¬äºŒéƒ¨åˆ†â€”â€”å¼‚æ­¥ioæŠ€æœ¯ä¹‹io_uringã€‚
