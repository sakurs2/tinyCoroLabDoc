---
show: step
version: 1.0
enable_checker: true
---

# è®¤è¯†io_uring

## è®¤è¯†io_uring

io_uringä½œä¸ºlinuxç³»ç»Ÿä¸‹çš„å¼‚æ­¥I/Oæ¥å£ï¼Œè‡ª2019å¹´å‘å¸ƒï¼Œç»è¿‡ä¸æ–­åœ°æ›´æ–°è¿­ä»£å·²ç»é€æ­¥æˆç†Ÿå¯ç”¨ã€‚ç›¸ä¿¡å„ä½è¯»è€…ä¹‹å‰ä¹Ÿæ¥è§¦è¿‡å„ç§å„æ ·çš„I/Oæ¨¡å‹ï¼Œæ¯”å¦‚ç½‘ç»œç¼–ç¨‹å¸¸ç”¨çš„å¤šè·¯å¤ç”¨epollä»¥åŠå¼‚æ­¥ç¼–ç¨‹åº“aioï¼Œä¸”ä¸Šè¿°I/Oæ¨¡å‹å› ä¸ºä¼˜å¼‚çš„æ€§èƒ½å·²ç»å¾—åˆ°å¹¿æ³›åº”ç”¨ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆlinuxç³»ç»Ÿè¿˜è¦å†è®¾è®¡å‡ºå¦ä¸€å¥—å¼‚æ­¥I/Oæ¥å£io_uringå‘¢ï¼Ÿæœ¬èŠ‚å°†ä¼šåŸºäºè¿™ä¸ªé—®é¢˜å¸¦è¯»è€…è®¤è¯†å¹¶æŒæ¡è¿™ç§å¼ºå¤§çš„å¼‚æ­¥I/OæŠ€æœ¯ã€‚

#### çŸ¥è¯†ç‚¹

- io_uringè¯ç”ŸèƒŒæ™¯åŠè®¾è®¡åŸç†
- io_uringæ ¸å¿ƒç³»ç»ŸAPI
- liburingç¼–ç¨‹å®æˆ˜

## linuxä¸‹ä¼ ç»ŸIOçš„ç¼ºé™·

å¯¹äºæœ€ä¸ºåŸºç¡€çš„åŒæ­¥I/Oå…¶ç¼ºé™·ä¸è¨€è€Œå–»ï¼Œçº¿ç¨‹éœ€è¦é˜»å¡ç­‰å¾…ç»“æœè¿”å›ï¼Œè¿™åœ¨I/Oå¯†é›†å‹åº”ç”¨ä¸­ä¼šäº§ç”Ÿä¸¥é‡çš„æ€§èƒ½ä½ä¸‹é—®é¢˜ã€‚

å¯¹äºå¤šè·¯å¤ç”¨I/Oçš„ä»£è¡¨epollï¼Œå®ƒèƒ½æ˜¾è‘—æé«˜ç¨‹åºåœ¨å¤§é‡å¹¶å‘è¿æ¥ä¸­åªæœ‰å°‘é‡æ´»è·ƒçš„æƒ…å†µä¸‹çš„ç³»ç»ŸCPUåˆ©ç”¨ç‡ï¼Œåœ¨ç½‘ç»œç¼–ç¨‹é¢†åŸŸå æ®äº†é‡è¦åœ°ä½ï¼Œä½†å…¶å­˜åœ¨ä¸€ä¸ªè‡´å‘½ç¼ºé™·ï¼šåªæ”¯æŒnetwork socketså’Œpipesï¼Œç”šè‡³è¿åŸºç¡€å­˜å‚¨æ–‡ä»¶çš„I/Oéƒ½ä¸æ”¯æŒã€‚

linuxä¸‹è¿˜å­˜åœ¨å¦ä¸€ç§é«˜æ•ˆçš„å¼‚æ­¥I/Oæ¨¡å‹â€”â€”aioï¼Œå…¶åŸç†æ˜¯ç”¨æˆ·ä½¿ç”¨`io_submit()`æäº¤I/Oè¯·æ±‚ï¼Œå†è°ƒç”¨`io_getevents()`æ¥æŸ¥çœ‹å“ªäº›è¯·æ±‚å·²ç»å®Œæˆï¼Œè¿™æ ·ä½¿å¾—ç”¨æˆ·å¯ä»¥ç¼–å†™å¼‚æ­¥æ‰§è¡Œçš„ä»£ç ï¼Œè€Œä¸”æ”¯æŒçš„I/Oç±»å‹ä¸ä»…æœ‰ç½‘ç»œI/Oè¿˜åŒ…æ‹¬æ–‡ä»¶å­˜å‚¨I/Oã€‚ä½†æ˜¯aioä»ç„¶å­˜åœ¨ä¸€äº›ç¼ºé™·ï¼š

- åªæ”¯æŒO_DIRECTæ–‡ä»¶ã€‚
- å¹¶éå®Œå…¨éé˜»å¡ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ä¼šå‡ºç°æ¥å£é˜»å¡çš„è¡Œä¸ºä¸”éš¾ä»¥é¢„æ–™ã€‚
- æ¥å£æ‹“å±•æ€§è¾ƒå·®ã€‚

ç»¼ä¸Šå¯ä»¥çœ‹å‡ºlinuxç³»ç»Ÿä¸‹è™½ç„¶å­˜åœ¨ä¼—å¤šI/Oæ¨¡å‹ï¼Œä½†å‡ä¼šæœ‰å„ç§ç¼ºé™·é™åˆ¶å…¶ä½¿ç”¨åœºæ™¯ï¼Œå› æ­¤linuxè¿«åˆ‡éœ€è¦ä¸€ç§æ–°çš„I/Oæ¨¡å‹æ¥è§£å†³è¿™äº›é—®é¢˜ã€‚

## åˆè¯†io_uring

io_uringçš„è®¾è®¡ç›®æ ‡æ˜¯æä¾›ä¸€ä¸ªç»Ÿä¸€ã€æ˜“ç”¨ã€å¯æ‰©å±•ã€åŠŸèƒ½ä¸°å¯Œã€é«˜æ•ˆçš„ç½‘ç»œå’Œç£ç›˜ç³»ç»Ÿæ¥å£ï¼Œä½œä¸ºio_uringçš„å¼€å‘è€…Jens Axboeåœ¨é•¿æ—¶é—´å¯¹Linux I/O stackçš„ç ”ç©¶ä¸­å¾—å‡ºäº†ä¸€ä¸ªç»“è®ºï¼šéšç€åŸºç¡€å­˜å‚¨è®¾å¤‡é€Ÿåº¦çš„æå‡ï¼Œä¸­æ–­é©±åŠ¨æ¨¡å¼çš„æ•ˆç‡å·²ç»ä½äºè½®è¯¢æ¨¡å¼ã€‚å› æ­¤io_uringçš„åŸºæœ¬é€»è¾‘ä¸aioç±»ä¼¼ï¼ŒåŒæ ·ä¸ºç”¨æˆ·æä¾›æäº¤I/Oçš„æ¥å£å’Œæ¥æ”¶å®Œæˆäº‹ä»¶çš„æ¥å£ï¼Œä½†å…¶å†…æ ¸è®¾è®¡ä¸aioå®Œå…¨ä¸åŒï¼š

- io_uringæ˜¯çœŸæ­£å¼‚æ­¥çš„ï¼Œè°ƒç”¨å…¶æ¥å£ä»…ä»…æ˜¯ä¸å†…æ ¸æ•°æ®ç»“æ„åšä¸€æ¬¡äº¤äº’ï¼Œç»å¯¹ä¸ä¼šåƒaioä¸€æ ·å‘ç”Ÿé¢„æœŸå¤–çš„é˜»å¡ã€‚
- æ”¯æŒä»»æ„ç±»å‹çš„I/Oã€‚
- äº¤äº’é€»è¾‘ç®€å•ï¼Œç”¨æˆ·ä»…éœ€è¦æäº¤I/Oï¼Œå®Œæˆä¹‹åI/Oäº‹ä»¶ä¼šè‡ªåŠ¨å‡ºç°åœ¨å®Œæˆé˜Ÿåˆ—é‡Œã€‚
- æ¥å£çµæ´»ã€å¯æ‹“å±•æ€§å¼ºã€‚åŸºäºio_uringç”šè‡³èƒ½é‡å†™linuxä¸‹çš„ç³»ç»Ÿè°ƒç”¨ã€‚

ç›¸æ¯”å…¶ä»–I/Oæ¨¡å‹ï¼Œio_uringå…·æœ‰æ˜æ˜¾çš„ä¼˜åŠ¿ã€‚å®ƒé€šè¿‡ç”¨æˆ·æ€å’Œå†…æ ¸æ€å…±äº«æäº¤é˜Ÿåˆ—ï¼ˆSubmission Queueï¼‰å’Œå®Œæˆé˜Ÿåˆ—ï¼ˆCompletion Queueï¼‰ï¼Œå‡å°‘äº†ç³»ç»Ÿè°ƒç”¨çš„æ¬¡æ•°å’Œä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€ã€‚åœ¨io_uringä¸­ï¼Œåº”ç”¨ç¨‹åºåªéœ€å°†I/Oè¯·æ±‚æ”¾å…¥æäº¤é˜Ÿåˆ—ï¼Œå†…æ ¸ä¼šåœ¨åå°å¤„ç†è¿™äº›è¯·æ±‚ï¼Œå¹¶å°†ç»“æœæ”¾å…¥å®Œæˆé˜Ÿåˆ—ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥éšæ—¶ä»å®Œæˆé˜Ÿåˆ—ä¸­è·å–ç»“æœï¼Œæ— éœ€é¢‘ç¹è¿›è¡Œç³»ç»Ÿè°ƒç”¨å’Œè½®è¯¢ã€‚æ­¤å¤–ï¼Œio_uringæ”¯æŒæ›´å¤šçš„å¼‚æ­¥ç³»ç»Ÿè°ƒç”¨ï¼Œä¸ä»…é€‚ç”¨äºå­˜å‚¨æ–‡ä»¶çš„ I/O æ“ä½œï¼Œè¿˜èƒ½å¾ˆå¥½åœ°åº”ç”¨äºç½‘ç»œå¥—æ¥å­—çš„I/Oå¤„ç†ï¼Œå…·æœ‰æ›´å¹¿æ³›çš„é€‚ç”¨æ€§å’Œæ›´é«˜çš„çµæ´»æ€§ã€‚

ç»¼åˆæ¥çœ‹io_uringæ›´åƒæ˜¯ä¸€ä¸ªå…­è¾¹å½¢æˆ˜å£«ï¼Œæ‹…è´Ÿç€å¤§ä¸€ç»Ÿlinuxä¸‹I/Oç¼–ç¨‹çš„é‡ä»»ï¼Œä¸è¿‡å…¶æ€§èƒ½ç›¸æ¯”aioå¹¶ä¸ä¼šæœ‰å·¨å¤§çš„æå‡ï¼Œä½†å…¶å¹¿æ³›çš„ioæ”¯æŒå’Œçµæ´»çš„æ‹“å±•æ€§å¯¹äºå®é™…å¼€å‘æ˜¯éå¸¸é‡è¦çš„ã€‚

## io_uringå®ç°åŸç†

io_uringå®ç°å¼‚æ­¥I/Oçš„æœ¬è´¨æ˜¯åˆ©ç”¨äº†ä¸€ä¸ªç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹ï¼Œæ¯ä¸ªuringåœ¨åˆå§‹åŒ–æ—¶ä¼šåœ¨å†…æ ¸ä¸­åˆ›å»ºæäº¤é˜Ÿåˆ—ï¼ˆsqï¼‰å’Œå®Œæˆé˜Ÿåˆ—ï¼ˆcqï¼‰ï¼Œå…¶æ•°æ®ç»“æ„å‡ä¸ºå›ºå®šé•¿åº¦çš„ç¯å½¢ç¼“å†²åŒºã€‚ç”¨æˆ·å‘sqæäº¤I/Oä»»åŠ¡ï¼Œå†…æ ¸è´Ÿè´£æ¶ˆè´¹ä»»åŠ¡ï¼Œå®Œæˆåçš„ä»»åŠ¡ä¼šè¢«æ”¾è‡³cqä¸­ç”±ç”¨æˆ·å–å‡ºï¼Œä¸ºäº†é™ä½ç”¨æˆ·æ€ä¸å†…æ ¸æ€ä¹‹é—´çš„æ•°æ®æ‹·è´ï¼Œio_uringä½¿ç”¨mmapè®©ç”¨æˆ·å’Œå†…æ ¸å…±äº«sqä¸cqçš„å†…å­˜ç©ºé—´ã€‚å…·ä½“å¯ä»¥çœ‹ä¸‹å›¾æ‰€ç¤ºï¼š

![io_uringç¤ºæ„å›¾](./sources/ch04_io_uring.png)

ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºæ ¸å¿ƒæ•°æ®å¹¶ä¸å­˜å‚¨åœ¨sqä¸­ï¼Œè€Œæ˜¯å­˜å‚¨åœ¨sqe arrayä¸­ï¼Œsqe arrayåŒ…å«å¤šä¸ªsqe entryï¼ˆsqeï¼‰ï¼Œæ¯ä¸ªsqeæ˜¯ä¸€ä¸ªç»“æ„ä½“å­˜å‚¨äº†I/Oè¯·æ±‚çš„è¯¦ç»†ä¿¡æ¯ï¼Œæ¯”å¦‚æ“ä½œç±»å‹ã€ç¼“å†²åŒºåœ°å€ã€ç¼“å†²åŒºé•¿åº¦å’Œæ–‡ä»¶æè¿°ç¬¦ç­‰ç­‰ï¼Œsqåªå­˜å‚¨ç´¢å¼•é¡¹ï¼Œç”¨æˆ·æ“ä½œçš„å®Œæ•´æµç¨‹åŒ…å«å¦‚ä¸‹æ­¥éª¤ï¼š

- ç”¨æˆ·è°ƒç”¨æ¥å£è·å–ç©ºé—²çš„sqe entryå¹¶å¡«å……I/Oä¿¡æ¯ã€‚
- ç”¨æˆ·å‘sqæäº¤sqeï¼Œsqè®°å½•å…¶ç´¢å¼•ä¿¡æ¯ã€‚
- å†…æ ¸ä»sqè·å–sqe entryå¹¶å¤„ç†ï¼Œå®Œæˆåå°†ç»“æœå°è£…æˆcqe entryæ”¾å…¥cqä¸­ï¼Œcqe entryå­˜å‚¨äº†I/Oæ“ä½œçš„ç»“æœã€‚
- ç”¨æˆ·ä»cqä¸­è·å–cqe entryï¼Œå¤„ç†ç»“æŸåæ ‡è®°è¯¥cqe entryï¼Œè¿™æ ·ç›¸å…³è”çš„sqe entryå›åˆ°ç©ºé—²çŠ¶æ€ç­‰å¾…å†åˆ©ç”¨ã€‚

io_uringçš„æ ¸å¿ƒç³»ç»ŸAPIæœ‰å¦‚ä¸‹ä¸‰ä¸ªï¼š

### `io_uring_setup`

```cpp
SYSCALL_DEFINE2(io_uring_setup, u32, entries,struct io_uring_params __user *,params)                                                                                                                                                           
{
        return io_uring_setup(entries, params);
}
```

- **åŠŸèƒ½**ï¼šåˆ›å»ºio_uringå®ä¾‹ã€‚
- **å‚æ•°entries**ï¼šç”¨æˆ·æœŸæœ›çš„å®Œæˆé˜Ÿåˆ—çš„å¤§å°ï¼Œå³é˜Ÿåˆ—å¯å®¹çº³I/Oè¯·æ±‚çš„æ•°é‡ã€‚
- **å‚æ•°params**ï¼š ä¸€ä¸ªæŒ‡å‘io_uring_paramsç»“æ„ä½“çš„æŒ‡é’ˆï¼Œè¯¥ç»“æ„ä½“ç”¨äºè¿”å›io_uringå®ä¾‹çš„ç›¸å…³å‚æ•°ï¼Œå¦‚å®é™…åˆ†é…çš„ SQ å’Œå®Œæˆé˜Ÿåˆ—ï¼ˆCQï¼‰çš„å¤§å°ã€é˜Ÿåˆ—çš„åç§»é‡ç­‰ä¿¡æ¯ã€‚
- **è¿”å›**ï¼šio_uringå®ä¾‹çš„æ–‡ä»¶æè¿°ç¬¦ã€‚

ç”¨æˆ·åœ¨ä½¿ç”¨io_uringå‰éœ€è¦è°ƒç”¨`io_uring_setup`æ¥å£åˆ›å»ºio_uringå®ä¾‹ï¼Œå†…æ ¸ä¼šæ ¹æ®å‚æ•°ä¸ºå…¶åˆ†é…å†…å­˜ç©ºé—´ï¼ŒæˆåŠŸåä¼šè¿”å›ä¸è¯¥io_uringç»‘å®šçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œåç»­æ“ä½œå‡åŸºäºè¯¥æ–‡ä»¶æè¿°ç¬¦ã€‚

### `io_uring_enter`

```cpp
SYSCALL_DEFINE6(io_uring_enter, unsigned int, fd, 
                                u32, to_submit,
                                u32, min_complete, 
                                u32, flags, 
                                const void __user *, argp,size_t, argsz)
```

- åŠŸèƒ½ï¼šæäº¤I/Oä»¥åŠç­‰å¾…I/Oæ“ä½œå®Œæˆã€‚
- å‚æ•°fdï¼šio_uringå®ä¾‹å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦ã€‚
- å‚æ•°to_submitï¼šç”¨æˆ·å‡†å¤‡æäº¤çš„I/Oè¯·æ±‚çš„æ•°é‡ã€‚
- å‚æ•°min_completeï¼šå‡½æ•°åœ¨è¿”å›å‰è‡³å°‘è¦å®Œæˆçš„I/Oè¯·æ±‚æ•°é‡ã€‚
- å‚æ•°flagsï¼šç”¨äºæ§åˆ¶io_uring_enterçš„è¡Œä¸ºã€‚

ä¸€èˆ¬ç”¨æˆ·é€šè¿‡`io_uring_submit`å‡½æ•°æäº¤I/Oè¯·æ±‚ï¼Œè€Œè¯¥å‡½æ•°å†…éƒ¨å®ç°æ­£æ˜¯é€šè¿‡`io_uring_enter`ã€‚

### `io_uring_register`

```cpp
SYSCALL_DEFINE4(io_uring_register, 
                unsigned int, fd, 
                unsigned int, opcode,
                void __user *, arg, unsigned int, nr_args)
```

- åŠŸèƒ½ï¼šç”¨äºæ³¨å†Œæ–‡ä»¶æè¿°ç¬¦ã€ç¼“å†²åŒºã€äº‹ä»¶æ–‡ä»¶æè¿°ç¬¦ç­‰èµ„æºåˆ°io_uringã€‚
- å‚æ•°fdï¼šio_uringå®ä¾‹å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦ã€‚
- å‚æ•°opcodeï¼šè¡¨ç¤ºæ³¨å†Œçš„ç±»å‹ã€‚
- å‚æ•°argï¼šæŒ‡é’ˆæŒ‡å‘ä¸opcodeç›¸å…³è”çš„å†…å®¹ã€‚

é€šè¿‡`io_uring_register`æ³¨å†Œæ–‡ä»¶æè¿°ç¬¦æˆ–ç¼“å†²åŒºç­‰èµ„æºåï¼Œå†…æ ¸åœ¨å¤„ç†I/Oè¯·æ±‚æ—¶ï¼Œå¯ä»¥ç›´æ¥è®¿é—®è¿™äº›é¢„å…ˆæ³¨å†Œçš„èµ„æºï¼Œè€Œæ— éœ€æ¯æ¬¡éƒ½é‡æ–°è®¾ç½®ç›¸å…³ä¿¡æ¯ï¼Œä»è€Œæé«˜äº†I/Oæ“ä½œçš„æ•ˆç‡ã€‚ä¾‹å¦‚ï¼Œåœ¨è¿›è¡Œå¤§é‡æ–‡ä»¶è¯»å†™æ“ä½œæ—¶ï¼Œé¢„å…ˆæ³¨å†Œæ–‡ä»¶æè¿°ç¬¦å¯ä»¥é¿å…æ¯æ¬¡æäº¤I/Oè¯·æ±‚æ—¶éƒ½è¿›è¡Œæ–‡ä»¶æè¿°ç¬¦çš„æŸ¥æ‰¾å’ŒéªŒè¯ï¼Œå‡å°‘äº†ç³»ç»Ÿå¼€é”€ï¼Œæå‡äº†I/Oæ€§èƒ½ã€‚

> ğŸ’¡**æ¯æ¬¡æäº¤I/Oå‰è¿›è¡Œç³»ç»Ÿè°ƒç”¨ä¼šä¸ä¼šå¾ˆå½±å“æ€§èƒ½ï¼Ÿ**
> ç­”æ¡ˆæ˜¯ä¼šçš„ï¼Œè€Œio_uringçš„è®¾è®¡è€…ä¹Ÿè€ƒè™‘åˆ°äº†è¿™ä¸€ç‚¹ï¼Œç”¨æˆ·å¯ä»¥åœ¨åˆå§‹åŒ–io_uringå®ä¾‹æ—¶æ·»åŠ `IORING_SETUP_SQPOLL`è¿™ä¸ªflagï¼Œè¿™æ ·å†…æ ¸ä¼šé¢å¤–å¯åŠ¨ä¸€ä¸ªsqçº¿ç¨‹è‡ªåŠ¨å»pollè¯·æ±‚é˜Ÿåˆ—ï¼Œæ­¤æ—¶ç”¨æˆ·è°ƒç”¨`io_uring_submit`å¹¶ä¸ä¼šæ¶‰åŠåˆ°ç³»ç»Ÿè°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯ä¸ä¼šè°ƒç”¨`io_uring_enter`ï¼Œè¿™æ ·å‡å°‘ç³»ç»Ÿè°ƒç”¨æ¬¡æ•°æ¥æé«˜æ•ˆç‡ï¼Œä¸è¿‡ä¸ºäº†é˜²æ­¢sqçº¿ç¨‹åœ¨pollçš„è¿‡ç¨‹ä¸­å¯¼è‡´ç³»ç»Ÿcpuå ç”¨è¿‡é«˜ï¼Œå› æ­¤åœ¨æŒ‡å®šæ—¶é—´åå¦‚æœæ²¡æœ‰ä»»ä½•è¯·æ±‚ï¼Œé‚£ä¹ˆsqçº¿ç¨‹ä¼šé™·å…¥ä¼‘çœ çŠ¶æ€ï¼Œæ­¤æ—¶éœ€è¦è°ƒç”¨`io_uring_enter`æ¥å”¤é†’sqçº¿ç¨‹ã€‚

## liburingå®æˆ˜

è™½ç„¶io_uringçš„æ ¸å¿ƒç³»ç»ŸAPIåªæœ‰3ä¸ªï¼Œä½†æƒ³è¦ç”¨å¥½è¿˜æ˜¯æœ‰ä¸€å®šéš¾åº¦çš„ï¼Œè€Œå¤§ä½¬ä»¬ä¹Ÿè€ƒè™‘åˆ°äº†è¿™ä¸€ç‚¹ï¼Œåœ¨io_uringæ¥å£çš„åŸºç¡€ä¸Šè¿›è¡ŒäºŒæ¬¡å°è£…å¼€å‘äº†liburingï¼Œè€Œæˆ‘ä»¬åç»­å®éªŒå°†ä¼šåŸºäºliburingè¿›è¡Œå¼€å‘ï¼Œå› æ­¤æœ¬å°èŠ‚å°†å¸¦å¤§å®¶é€šè¿‡liburingæä¾›çš„æ¥å£ä½¿ç”¨io_uringï¼Œç”¨æˆ·éœ€è¦åœ¨linuxå†…æ ¸çš„æ“ä½œç³»ç»Ÿï¼ˆwslã€è™šæ‹Ÿæœºå‡å¯ï¼‰ä¸‹è¿›è¡Œæœ¬èŠ‚æ“ä½œã€‚

é¦–å…ˆå…‹éš†æœ€æ–°çš„liburingé¡¹ç›®ï¼š

```shell
git clone https://github.com/axboe/liburing.git
```

ç¼–è¯‘å¹¶å®‰è£…ï¼š

```shell
cd liburing
./configure --cc=gcc --cxx=g++;
make -j$(nproc);
make liburing.pc
sudo make install;
```

ä¸‹é¢ç»™å‡ºç”¨liburingå®ç°echo serverçš„æ ·ä¾‹ç¨‹åºï¼š

```cpp
// echo_server.cpp
#include <liburing.h>
#include <netinet/in.h>
#include <stdio.h>
#include <string.h>
#include <unistd.h>

#define EVENT_ACCEPT 0
#define EVENT_READ 1
#define EVENT_WRITE 2

struct conn_info
{
  int fd;
  int event;
};

int init_server(unsigned short port)
{
  int sockfd = socket(AF_INET, SOCK_STREAM, 0);
  struct sockaddr_in serveraddr;
  memset(&serveraddr, 0, sizeof(struct sockaddr_in));
  serveraddr.sin_family = AF_INET;
  serveraddr.sin_addr.s_addr = htonl(INADDR_ANY);
  serveraddr.sin_port = htons(port);

  if (-1 == bind(sockfd, (struct sockaddr *)&serveraddr, sizeof(struct sockaddr)))
  {
    perror("bind");
    return -1;
  }

  listen(sockfd, 10);

  return sockfd;
}

#define ENTRIES_LENGTH 1024
#define BUFFER_LENGTH 1024

void set_event_recv(struct io_uring *ring, int sockfd, void *buf, size_t len, int flags)
{
  struct io_uring_sqe *sqe = io_uring_get_sqe(ring);

  struct conn_info accept_info = {
      .fd = sockfd,
      .event = EVENT_READ,
  };

  io_uring_prep_recv(sqe, sockfd, buf, len, flags); // ä¸ºsqe entryå¡«å……è¯»äº‹ä»¶æ‰€éœ€çš„ç›¸å…³æ•°æ®
  memcpy(&sqe->user_data, &accept_info, sizeof(struct conn_info));
}

void set_event_send(struct io_uring *ring, int sockfd, void *buf, size_t len, int flags)
{
  struct io_uring_sqe *sqe = io_uring_get_sqe(ring);

  struct conn_info accept_info = {
      .fd = sockfd,
      .event = EVENT_WRITE,
  };

  io_uring_prep_send(sqe, sockfd, buf, len, flags); // ä¸ºsqe entryå¡«å……å†™äº‹ä»¶æ‰€éœ€çš„ç›¸å…³æ•°æ®
  memcpy(&sqe->user_data, &accept_info, sizeof(struct conn_info));
}

void set_event_accept(struct io_uring *ring, int sockfd, struct sockaddr *addr, socklen_t *addrlen, int flags)
{
  struct io_uring_sqe *sqe = io_uring_get_sqe(ring);

  struct conn_info accept_info = {
      .fd = sockfd,
      .event = EVENT_ACCEPT,
  };

  io_uring_prep_accept(sqe, sockfd, (struct sockaddr *)addr, addrlen, flags); // ä¸ºsqe entryå¡«å……è¿æ¥äº‹ä»¶æ‰€éœ€çš„ç›¸å…³æ•°æ®
  memcpy(&sqe->user_data, &accept_info, sizeof(struct conn_info));
}

int main(int argc, char *argv[])
{
  unsigned short port = 8000;
  int sockfd = init_server(port);

  struct io_uring_params params;
  memset(&params, 0, sizeof(params));

  struct io_uring ring;
  io_uring_queue_init_params(ENTRIES_LENGTH, &ring, &params); // æ ¹æ®å‚æ•°åˆå§‹åŒ–io_uringå®ä¾‹

  struct sockaddr_in clientaddr;
  socklen_t len = sizeof(clientaddr);
  set_event_accept(&ring, sockfd, (struct sockaddr *)&clientaddr, &len, 0);

  char buffer[BUFFER_LENGTH] = {0};

  while (1)
  {
    io_uring_submit(&ring); // æäº¤I/Oè¯·æ±‚

    struct io_uring_cqe *cqe;
    io_uring_wait_cqe(&ring, &cqe); // ç­‰å¾…è‡³å°‘ä¸€ä¸ªå®Œæˆäº‹ä»¶

    struct io_uring_cqe *cqes[128];
    int nready = io_uring_peek_batch_cqe(&ring, cqes, 128); // æ‰¹é‡è·å–å®Œæˆäº‹ä»¶

    int i = 0;
    for (i = 0; i < nready; i++)
    {
      struct io_uring_cqe *entries = cqes[i];
      struct conn_info result;
      memcpy(&result, &entries->user_data, sizeof(struct conn_info));
      if (result.event == EVENT_ACCEPT)
      {
        set_event_accept(&ring, sockfd, (struct sockaddr *)&clientaddr, &len, 0);
        int connfd = entries->res;
        set_event_recv(&ring, connfd, buffer, BUFFER_LENGTH, 0);
      }
      else if (result.event == EVENT_READ)
      {
        int ret = entries->res;
        if (ret == 0)
        {
          close(result.fd);
        }
        else if (ret > 0)
        {
          set_event_send(&ring, result.fd, buffer, ret, 0);
        }
      }
      else if (result.event == EVENT_WRITE)
      {
        int ret = entries->res;
        set_event_recv(&ring, result.fd, buffer, BUFFER_LENGTH, 0);
      }
    }
    io_uring_cq_advance(&ring, nready); // æ‰¹é‡æ ‡è®°å®Œæˆäº‹ä»¶ï¼Œä½¿å¾—å…³è”çš„sqeå¯ä»¥è¢«é‡æ–°ä½¿ç”¨
  }
  return 0;
}
```

ç¼–è¯‘å¹¶è¿è¡Œè¯¥ç¨‹åºï¼š

```shell
g++ echo_server.cpp -luring -o echo_server
./echo_server
```

æ­¤æ—¶è¯»è€…å¯ä»¥ä½¿ç”¨`nc 127.0.0.1 8000`å‘½ä»¤æ¥ä¸è¯¥æœåŠ¡å™¨é€šä¿¡æµ‹è¯•liburingæ˜¯å¦å·¥ä½œæ­£å¸¸ã€‚

<!-- TODO: æ·»åŠ eventfdçš„å†…å®¹ -->
å¯¹äºæ ·ä¾‹ç¨‹åºæ¶‰åŠåˆ°çš„liburingçš„æ¥å£å‡æ·»åŠ äº†æ³¨é‡Šï¼Œ

liburingçš„æ¥å£æ•°é‡ä¼—å¤šï¼Œå¾ˆéš¾ä¹Ÿæ²¡å¿…è¦ä¸€ä¸€æ‹¿å‡ºæ¥è®²è§£ï¼Œç”¨æˆ·å¯ä»¥åœ¨`liburing.h`ä¸­è¿›è¡ŒæŸ¥çœ‹å„ä¸ªæ¥å£ï¼Œè¿™é‡Œä¸ºå¤§å®¶æ¨èä¸¤ä¸ªå®˜æ–¹ç½‘ç«™ç”¨äºå¤§å®¶æ›´æ·±å…¥çš„äº†è§£liburingï¼š

- [Lord of the io_uring](https://unixism.net/loti/index.html)ï¼šå®˜æ–¹æä¾›çš„ç”¨äºä»‹ç»io_uringå’Œliburingçš„ç½‘ç«™ï¼Œé‡Œé¢æä¾›äº†io_uringçš„è®¾è®¡æ€è·¯ä»¥åŠç”¨liburingå®ç°çš„å„ä¸ªæ ·ä¾‹ç¨‹åºï¼Œå¹¶ä¸”è¿˜è®²è§£äº†liburingçš„æ ¸å¿ƒæ¥å£ã€‚
- [Linux man pages](https://man7.org/linux/man-pages/index.html)ï¼šliburingæ¶‰åŠçš„APIç”¨æˆ·å‡å¯åœ¨è¯¥ç½‘ç«™ä¸ŠæŸ¥æ‰¾ä½¿ç”¨è¯´æ˜ã€‚

![linux man pages](./sources/ch04_man_pages.png)

## liburingç»“åˆeventfd

liburingå…è®¸`io_uring`å®ä¾‹ä¸eventfdç»‘å®šï¼Œé‚£ä¹ˆä»€ä¹ˆæ˜¯eventfdå‘¢ï¼Ÿ

eventfdæ˜¯linuxä¸‹çš„è½»é‡çº§çš„ç”¨äºäº‹ä»¶é€šçŸ¥çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä½¿ç”¨æ–¹æ³•åŒ…å«ä¸‹åˆ—ä¸¤ä¸ªè¯»å†™æ¥å£ä»¥åŠåˆå§‹åŒ–æ¥å£ï¼š

```cpp
#include <sys/eventfd.h>
/* Return file descriptor for generic event channel.  Set initial
   value to COUNT.  */
extern int eventfd (unsigned int __count, int __flags) __THROW;
/* Read event counter and possibly wait for events.  */
extern int eventfd_read (int __fd, eventfd_t *__value);
/* Increment event counter.  */
extern int eventfd_write (int __fd, eventfd_t __value);
```

eventfdå®ç°çš„é€»è¾‘æ˜¯ç´¯è®¡è®¡æ•°ï¼Œå½“è®¡æ•°ä¸º0åˆ™è¯»æ“ä½œé˜»å¡ï¼Œå¦åˆ™è¯»å–çš„æ˜¯å½“å‰çš„è®¡æ•°å€¼å¹¶å°†eventfdçš„è®¡æ•°æ¸…0ã€‚å†™æ“ä½œæ˜¯ä¸ä¼šé˜»å¡çš„ï¼Œä½†å†™å…¥çš„å€¼å¹¶ä¸ä¼šç›´æ¥ä½œä¸ºeventfdçš„è®¡æ•°ï¼Œè€Œæ˜¯ä»¥ç´¯åŠ åˆ°åŸæœ¬è®¡æ•°çš„æ–¹å¼å­˜å‚¨ã€‚è¿™æ ·å°±å¯ä»¥å®ç°äº‹ä»¶é€šçŸ¥æœºåˆ¶äº†ï¼Œä¹‹æ‰€ä»¥ç§°ä¸ºè½»é‡çº§æ˜¯å› ä¸ºå¯¹eventfdçš„æ“ä½œåŸºæœ¬åœ¨1uså·¦å³ã€‚

è°ƒç”¨ä¸‹åˆ—å‡½æ•°æ¥å°†`io_uring`ä¸eventfdç»‘å®šã€‚

```cpp
int io_uring_register_eventfd(struct io_uring *ring, int event_fd);
```

å½“`io_uring`äº§ç”ŸIOå®Œæˆäº‹ä»¶æ—¶ä¼šå‘eventfdå†™å…¥å€¼ï¼Œé‚£ä¹ˆè¿™ä¸ªå†™å…¥å€¼æœ‰å•¥å«ä¹‰å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥çœ‹ä¸‹é¢ä¸€æ®µå®æˆ˜ä»£ç ï¼š

```cpp
// main.cpp
// g++ main.cpp -o main -luring
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <liburing.h>
#include <sys/eventfd.h>

int main()
{
  struct io_uring ring;
  int m_efd = eventfd(0, 0);

  if (io_uring_queue_init(16, &ring, 0) != 0)
  {
    perror("io_uring_queue_init");
    return 1;
  }

  if (io_uring_register_eventfd(&ring, m_efd) != 0)
  {
    perror("io_uring_register_eventfd");
    return 1;
  }

  // æäº¤å¤šä¸ª NOP æ“ä½œï¼ŒNOPä¼šåœ¨æäº¤åç«‹åˆ»äº§ç”Ÿcqe
  for (int i = 0; i < 10; i++)
  {
    struct io_uring_sqe *sqe = io_uring_get_sqe(&ring);
    io_uring_prep_nop(sqe);
    io_uring_submit(&ring);
  }

  // ç­‰å¾… eventfd é€šçŸ¥
  uint64_t events;
  if (read(m_efd, &events, sizeof(events)) < 0)
  {
    perror("read eventfd");
    return 1;
  }
  printf("Received %llu events\n", events);

  // æ¸…ç†
  io_uring_queue_exit(&ring);
  close(m_efd);
  return 0;
}
```

æ­¤æ—¶æ‰“å°å‡ºçš„ä»eventfdè¯»å‡ºæ¥çš„æ•°å­—æ˜¯å¤šå°‘ï¼Ÿæ­£ç¡®ç­”æ¡ˆæ˜¯10ï¼Œé‚£æ˜¯ä¸æ˜¯è¿™ä¸ªå€¼è¡¨ç¤ºå½“å‰`io_uring`å†…çš„cqeæ•°é‡å‘¢ï¼Ÿå¯¹ä¸Šé¢çš„ä»£ç ç¨ä½œä¿®æ”¹ï¼š

```cpp
// æäº¤å¤šä¸ª NOP æ“ä½œï¼ŒNOPä¼šåœ¨æäº¤åç«‹åˆ»äº§ç”Ÿcqe
for (int i = 0; i < 10; i++)
{
  struct io_uring_sqe *sqe = io_uring_get_sqe(&ring);
  io_uring_prep_nop(sqe);
  // io_uring_submit(&ring);
}
io_uring_submit(&ring);
```

æ­¤æ—¶æ‰“å°å‡ºçš„ä»eventfdè¯»å‡ºæ¥çš„æ•°å­—åˆæ˜¯å¤šå°‘ï¼Ÿç­”æ¡ˆæ˜¯1ï¼Œå› ä¸ºä¿®æ”¹åçš„ä»£ç çš„æäº¤å±äºæ‰¹é‡æäº¤ï¼Œæ‰¹é‡æäº¤å±äº`io_uring`çš„ç‰¹æ€§ï¼Œå› æ­¤ä»eventfdè¯»å‡ºæ¥å€¼åæ˜ å‡ºçš„æ˜¯å®Œæˆçš„æ‰¹æ¬¡æ•°ã€‚

ä¸ç®¡æ€æ ·ï¼Œåªè¦ä»eventfdè¯»å‡ºå€¼ï¼Œä¸ç”¨ç®¡å€¼å¤§å°ï¼Œæ­¤æ—¶ä¸€å®šæ˜¯å­˜åœ¨cqeçš„ï¼Œåªéœ€è¦å–å‡ºæ¥å¤„ç†å°±å¥½ï¼Œé€šè¿‡å°†liburingæ­é…eventfdï¼Œæˆ‘ä»¬ä¾¿èƒ½å®ç°ç±»ä¼¼epollçš„äº‹ä»¶å¾ªç¯æœºåˆ¶ã€‚

## å‚è€ƒæ–‡çŒ®

- [è§£å¯†é«˜æ€§èƒ½å¼‚æ­¥I/Oï¼šio_uringçš„é­”åŠ›ä¸åº”ç”¨](https://zhuanlan.zhihu.com/p/21039819177)

## å®éªŒæ€»ç»“

æœ¬æ–‡ä¸ºå¤§å®¶è®²è§£äº†io_uringçš„è¯ç”ŸèƒŒæ™¯å³å®ƒè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Œéšåè®²è§£äº†io_uringçš„æ ¸å¿ƒå®ç°åŸç†å¹¶ä»‹ç»å…¶ä¸‰ä¸ªæ ¸å¿ƒç³»ç»ŸAPIï¼Œæœ€åä»‹ç»liburingå¹¶ç»™å‡ºå®æˆ˜ç¨‹åºè®²è§£ï¼Œè‡³æ­¤tinyCoroLabçš„å‰ç½®é“ºå«çŸ¥è¯†å…¨éƒ¨ç»“æŸï¼Œåç»­æˆ‘ä»¬å°†æ­£å¼å¼€å§‹tinyCoroLabå®æˆ˜ã€‚
