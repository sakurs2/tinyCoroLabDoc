---
show: step
version: 1.0
enable_checker: true
---
# tinyCoroLab4a: æ„å»ºåŸºç¡€åç¨‹åŒæ­¥ç»„ä»¶event

## tinyCoroLab4aå®éªŒç®€ä»‹

æœ¬èŠ‚æˆ‘ä»¬å°†æ­£å¼å¼€å§‹tinyCoroLab4aï¼Œå³æ„å»ºåŸºç¡€åç¨‹åŒæ­¥ç»„ä»¶eventã€‚åœ¨å¼€å§‹æœ¬èŠ‚å®éªŒå‰è¯·å®éªŒè€…åŠ¡å¿…ç¡®ä¿å·²é€å½»ç†è§£lab4 preæ‰€è®²çš„å†…å®¹ã€‚

#### é¢„å¤‡çŸ¥è¯†

> âš ï¸é¢„å¤‡çŸ¥è¯†å³åœ¨å®éªŒå¼€å§‹å‰ä½ åº”è¯¥å·²ç»æŒæ¡çš„çŸ¥è¯†ï¼Œä¸”åœ¨[çŸ¥è¯†é“ºå«ç« èŠ‚]()ä¸­å‡æœ‰æ¶‰åŠ

- **C++åç¨‹awaiterçš„æ¦‚å¿µ**
- **C++æ¨¡æ¿ç¼–ç¨‹**

## ğŸ“–lab4aä»»åŠ¡ä¹¦

### å®éªŒå‰ç½®è®²è§£

æœ¬èŠ‚å®éªŒæ¶‰åŠåˆ°çš„æ ¸å¿ƒæ–‡ä»¶ä¸º[include/coro/comp/event.hpp](https://github.com/sakurs2/tinyCoroLab/blob/v1.0/include/coro/comp/event.hpp)å’Œ[src/comp/event.cpp](https://github.com/sakurs2/tinyCoroLab/blob/v1.0/src/comp/event.cpp)ï¼Œå®éªŒè€…éœ€è¦é¢„å…ˆæ‰“å¼€æ–‡ä»¶æµè§ˆå¤§è‡´ä»£ç ç»“æ„ï¼Œä¸‹é¢é’ˆå¯¹è¯¥æ–‡ä»¶å†…å®¹è¿›è¡Œè®²è§£ã€‚

[include/coro/comp/event.hpp](https://github.com/sakurs2/tinyCoroLab/blob/v1.0/include/coro/comp/event.hpp)ä¸­ç»™å‡ºäº†ä¸€ä¸ªéå¸¸ç®€å•çš„eventçš„å®šä¹‰ï¼Œæ³¨æ„è¯¥å®šä¹‰ä»…ä»…æ˜¯ä¸€ä¸ªå½¢å¼ï¼Œä¸å…·å¤‡eventçš„æ­£ç¡®åŠŸèƒ½ï¼Œä½†æ˜¯**å…¶ç±»ä»¥åŠå‡½æ•°å£°æ˜å½¢å¼æ˜¯æ­£ç¡®çš„**ã€‚

å¦å¤–è¯¥æ–‡ä»¶é¢„å®šä¹‰äº†`event_guard`ï¼Œåœ¨å…¶ç”Ÿå‘½å‘¨æœŸç»“æŸåå¯ä»¥è‡ªåŠ¨å¯¹eventè°ƒç”¨setï¼Œä½†ä»…é™äºæ¨¡æ¿å‚æ•°ä¸ºç©ºçš„eventã€‚å®éªŒè€…ä¸è¦ä¿®æ”¹ä»»ä½•å…³äºguardçš„å®šä¹‰ã€‚

### âš ï¸æ³¨æ„äº‹é¡¹

- è¯·ç¡®ä¿å·²é˜…è¯»è¿‡**tinyCoroLab Introduce**ç« èŠ‚ã€‚
- ä¸ºäº†ç¡®ä¿æ­£ç¡®å®ç°ç›®æ ‡å‡½æ•°ï¼Œå®éªŒè€…å¯èƒ½éœ€è¦åšä¸€äº›é¢å¤–æ“ä½œï¼šæ–°å¢ç±»ã€ä¿®æ”¹ç°æœ‰ç±»çš„å®ç°ã€è¡¥å……ç°æœ‰ç±»çš„æ–¹æ³•å’Œæˆå‘˜å˜é‡ç­‰æ“ä½œï¼Œè¯·éµå¾ª**free-designå®éªŒåŸåˆ™**ã€‚
- ä½ éœ€è¦ä»”ç»†è¯„ä¼°å¾…å®ç°çš„æ¥å£æ˜¯å¦éœ€è¦æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚
- ä»»ä½•å¯¼è‡´æµ‹è¯•å¡ä½ã€å´©æºƒç­‰æ— æ³•ä½¿æµ‹è¯•é¡ºåˆ©é€šè¿‡çš„æƒ…å†µéƒ½è¡¨æ˜ä½ çš„ä»£ç å­˜åœ¨é—®é¢˜ã€‚

### å®éªŒä»»åŠ¡ä¹¦

#### ğŸ§‘â€ğŸ’»Task #1 - å®ç°event

##### ä»»åŠ¡ç›®æ ‡

tinyCoroçš„eventä¸C++ä¸­çš„std::promiseåŠŸèƒ½ç±»ä¼¼ï¼Œå¸¦æœ‰ä¸€ä¸ªè¿”å›ç±»å‹æ¨¡æ¿å‚æ•°ä¸”é»˜è®¤ä¸ºç©ºï¼Œå¹¶ä¸”æä¾›`set`ä»¥åŠ`wait`ä¸¤ä¸ªæ¥å£ï¼Œ`set`å¯ä»¥ç›´æ¥è°ƒç”¨ï¼Œä½†è°ƒç”¨`wait`éœ€è¦æ˜¯åç¨‹çš„å½¢å¼`co_await wait()`ã€‚

å¯¹äºæ¨¡æ¿å‚æ•°ä¸ºç©ºçš„eventï¼Œå…¶åŠŸèƒ½ç±»ä¼¼äºä¼ é€’ä¿¡å·ï¼Œå…¶æ ¸å¿ƒå‡½æ•°å£°æ˜å¦‚ä¸‹ï¼š

```cpp
auto set() noexcept -> void; // æ™®é€šè°ƒç”¨
auto wait() noexcept -> awaiter; // åç¨‹è°ƒç”¨ï¼Œawaiterçš„await_resumeè¿”å›void
```

> ğŸ’¡**ä»€ä¹ˆæ˜¯æ™®é€šè°ƒç”¨å’Œåç¨‹è°ƒç”¨ï¼Ÿ**
> æ™®é€šè°ƒç”¨å°±æ˜¯åƒæ­£å¸¸å‡½æ•°è°ƒç”¨å³å¯ï¼Œåç¨‹è°ƒç”¨éœ€è¦åœ¨è¢«è°ƒç”¨å‡½æ•°å‰æ·»åŠ co_awaitå…³é”®å­—ï¼Œå› æ­¤åç¨‹è°ƒç”¨åªèƒ½å‡ºç°åœ¨åç¨‹å‡½æ•°å†…ã€‚
> ğŸ’¡**ä¸ºä½•æœ‰äº›æ–¹æ³•æ˜¯æ™®é€šè°ƒç”¨è€Œæœ‰äº›æ˜¯åç¨‹è°ƒç”¨ï¼Ÿ**
> å¯¹äºå¯èƒ½ä¼šè®©åç¨‹é™·å…¥suspendçŠ¶æ€çš„è°ƒç”¨éœ€è¦æ˜¯åç¨‹è°ƒç”¨ï¼Œå¦åˆ™å°±å®ç°ä¸ºæ™®é€šè°ƒç”¨å³å¯ï¼Œä¸è¦äº§ç”Ÿä¸å¿…è¦çš„åç¨‹è°ƒç”¨å¼€é”€ã€‚

å¯¹äºæ¨¡æ¿å‚æ•°éç©ºçš„eventï¼Œå…¶åŠŸèƒ½ç±»ä¼¼äºä¼ é€’æ•°æ®ï¼Œå…¶æ ¸å¿ƒå‡½æ•°å£°æ˜å¦‚ä¸‹ï¼š

```cpp
template<typename value_type>
auto set(value_type&& value) noexcept -> void; // æ™®é€šè°ƒç”¨
auto wait() noexcept -> awaiter; // åç¨‹è°ƒç”¨ï¼Œawaiterçš„await_resumeè¿”å›setè®¾ç½®çš„å€¼
```

å¯¹å…¶è°ƒç”¨`co_await event.wait()`çš„è¿”å›å€¼æ˜¯setè®¾ç½®çš„å€¼ï¼Œæ³¨æ„å› ä¸ºè€ƒè™‘åˆ°éšå¼è½¬æ¢é—®é¢˜ï¼Œsetçš„å…¥å‚è¢«è®¾ç½®æˆæ¨¡æ¿å‚æ•°`value_type`ï¼Œä¸eventçš„æ¨¡æ¿å‚æ•°`return_type`å¹¶ä¸åŒï¼Œå®éªŒè€…å¯ä»¥ä¸ä½¿ç”¨è¿™ç§æ¨¡æ¿å½¢å¼ï¼Œåªè¦ä¿è¯æ•°æ®èƒ½è¢«æ­£ç¡®ä¼ é€’å³å¯ã€‚

ä¸‹é¢ç»™å‡ºeventçš„ä½¿ç”¨åœºæ™¯ä¾¿äºå®éªŒè€…ç†è§£ï¼š

```cpp
// æ¨¡æ¿å‚æ•°ä¸ºç©ºçš„event
event<> ev;
task<> set_func() { // æ‰‹åŠ¨è°ƒç”¨set
  // codes...
  ev.set();
}
task<> set_func() { // è‡ªåŠ¨è°ƒç”¨set
  auto guard = event_guard(ev);
  // codes...
  // auto set ev
}
task<> wait_func() {
  co_await ev.wait();
  // codes ...
}

// æ¨¡æ¿å‚æ•°éç©ºçš„event
event<int> ev;
task<> set_func() {
  // codes...
  ev.set(number);
}
task<> wait_func() {
  auto number = co_await ev.wait();
  // codes ...
}
```

##### æ¶‰åŠæ–‡ä»¶

- [include/coro/comp/event.hpp](https://github.com/sakurs2/tinyCoroLab/blob/v1.0/include/coro/comp/event.hpp)
- [src/comp/event.cpp](https://github.com/sakurs2/tinyCoroLab/blob/v1.0/src/comp/event.cpp)

##### å¾…å®ç°å‡½æ•°

- `coro::event::wait`
- `coro::event::set`

#### è¡¥å……è¯´æ˜

- **ä½ çš„å®ç°å¿…é¡»åŒ…å«ä»»åŠ¡ç›®æ ‡ä¸­æè¿°çš„å‡½æ•°ä¸”å‡½æ•°å£°æ˜å½¢å¼å¿…é¡»ä¸€è‡´ï¼Œä¸ç„¶æ— æ³•æ­£å¸¸ç¼–è¯‘**
- **åç¨‹å‡½æ•°çš„è¿”å›ç±»å‹å¯ä»¥è¢«ä¿®æ”¹ï¼Œä½†å¿…é¡»æ˜¯awaiteræˆ–è€…awaitableç±»å‹ä¸”await_resumeè¿”å›ç±»å‹ä¸ä»»åŠ¡ä¹¦è§„å®šä¸€è‡´**
- **è¯·åŠ¡å¿…è€ƒè™‘å¤šçº¿ç¨‹å®‰å…¨æ€§é—®é¢˜**
- **å› ä¸ºtinyCoroè®¾è®¡é—®é¢˜ï¼Œæ‰€ä»¥åç¨‹ç»„ä»¶æ¢å¤suspend awaiteræ—¶æœ€å¥½å°†å…¶æ´¾å‘åˆ°å…¶åŸæœ¬è¿è¡Œçš„context**

### ğŸ”–æµ‹è¯•

#### åŠŸèƒ½æµ‹è¯•

åŠŸèƒ½æµ‹è¯•åœºæ™¯ä¸»è¦é’ˆå¯¹ï¼š

- **å•ä¸ªcontextä¸‹eventçš„waitä¸set**
- **å¤šä¸ªcontextä¸‹eventçš„waitä¸set**

å®Œæˆæœ¬èŠ‚å®éªŒåï¼Œå®éªŒè€…è¯·åœ¨æ„å»ºç›®å½•ä¸‹æ‰§è¡Œä¸‹åˆ—æŒ‡ä»¤æ¥æ„å»ºä»¥åŠè¿è¡Œæµ‹è¯•ç¨‹åºï¼š

```shell
make build-lab4a # æ„å»º
make test-lab4a # è¿è¡Œ
```

#### å†…å­˜å®‰å…¨æµ‹è¯•

åœ¨æ„å»ºç›®å½•ä¸‹è¿è¡Œä¸‹åˆ—æŒ‡ä»¤æ¥æ‰§è¡Œå†…å­˜å®‰å…¨æµ‹è¯•ï¼š

```shell
make memtest-lab4a
```

æµ‹è¯•é€šè¿‡ä¼šæç¤ºpassï¼Œä¸é€šè¿‡ä¼šç»™å‡ºvalgrindçš„è¾“å‡ºæ–‡ä»¶ä½ç½®ï¼Œè¯·å®éªŒè€…æ ¹æ®è¯¥æ–‡ä»¶æ’æŸ¥å†…å­˜æ•…éšœã€‚

#### æ€§èƒ½æµ‹è¯•

> ğŸ’¡**tinyCoroLab**é¢„ç½®äº†ç”¨äºæ€§èƒ½è°ƒä¼˜çš„ç«ç„°å›¾ç”Ÿæˆè„šæœ¬å“¦ï¼è¯¦æƒ…è¯·æŸ¥çœ‹[scripts/README.MD](https://github.com/sakurs2/tinyCoroLab/blob/v1.0/scripts/README.MD)ã€‚

åœ¨**tinyCoroLab Introduce**ç« èŠ‚ä¸­æåˆ°æ€§èƒ½æµ‹è¯•çš„ä¸‰ç§æ¨¡å‹ï¼š

- **thread_pool_stl_XX:** ä½¿ç”¨ç®€å•çš„çº¿ç¨‹æ± å’Œstlç»„ä»¶ã€‚
- **coro_stl_XX:** ä½¿ç”¨coroè°ƒåº¦å™¨å’Œstlç»„ä»¶ã€‚
- **coro_XX:** ä½¿ç”¨coroè°ƒåº¦å™¨å’Œcoroç»„ä»¶ã€‚

å¯¹äºlab4açš„æ€§èƒ½æµ‹è¯•ï¼Œcoroç»„ä»¶å³å®éªŒè€…å®ç°çš„eventï¼Œstlç»„ä»¶å³C++ std::promsieï¼Œæµ‹è¯•åœºæ™¯ä¸ºå•ä¸ªå‡½æ•°setå’Œå¤šä¸ªå‡½æ•°waitï¼Œå¹¶æµ‹é‡æ‰§è¡Œæ€»è€—æ—¶ã€‚

> å®éªŒè€…åªè¦é‡ç‚¹å…³æ³¨**coro_stl_XX**å’Œ**coro_XX**æ¨¡å‹è¾“å‡ºçš„ç»“æœå·®å¼‚å³å¯ï¼Œè¯¥ç»“æœåæ˜ çš„å®éªŒè€…çš„å®ç°ä¸stlå®ç°çš„æ€§èƒ½å·®å¼‚ã€‚ç”±äºçº¿ç¨‹åœ¨å—çº¿ç¨‹åŒæ­¥ç»„ä»¶å½±å“è€Œé™·å…¥é˜»å¡æ€æ—¶å¹¶ä¸ä¼šé€‰æ‹©æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œä½†tinyCoroæ‰§è¡Œå¼•æ“ä¼šï¼Œå› æ­¤ä¸ºäº†ä¿è¯å…¬å¹³æ€§ï¼Œæ¯ä¸ªçº¿ç¨‹åªä¼šè¢«æ´¾å‘ä¸€ä¸ªä»»åŠ¡ï¼Œæ€§èƒ½æµ‹è¯•ä¹Ÿä»…ä»…æ˜¯æƒ³é‡ç‚¹å…³æ³¨å®éªŒè€…çš„å®ç°ä¸stlå®ç°çš„æ€§èƒ½å·®å¼‚ã€‚

åœ¨æ„å»ºç›®å½•ä¸‹è¿è¡Œä¸‹åˆ—æŒ‡ä»¤æ¥æ„å»ºå’Œè¿è¡Œæ€§èƒ½æµ‹è¯•ï¼š

```shell
make benchbuild-lab4a # æ„å»º
make benchtest-lab4a # è¿è¡Œ
```
